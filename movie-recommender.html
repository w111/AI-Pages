<!DOCTYPE html>
<!--
–¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï

–¶–µ–ª—å: –°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Å–µ—Ä–∏–∞–ª–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Cosine Similarity.

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–∏–∞–ª–æ–≤ –∏–∑ API
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç 5-10 —Å–µ—Ä–∏–∞–ª–æ–≤ –ø–æ —à–∫–∞–ª–µ 1-5
3. –†–∞—Å—á—ë—Ç —Å—Ö–æ–∂–µ—Å—Ç–∏ —á–µ—Ä–µ–∑ cosine similarity (dot product)
4. –¢–æ–ø-10 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Å –ø–æ—Å—Ç–µ—Ä–∞–º–∏
5. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–µ–º–Ω–æ–π/—Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã
6. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω
7. –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å (—Ä—É—Å—Å–∫–∏–π/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π)

–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. Vanilla JavaScript –±–µ–∑ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤
2. TVMaze API –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–∏–∞–ª–æ–≤ (–±–µ–∑ –∫–ª—é—á–∞)
3. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫ –≤ localStorage
4. CSS Grid –∏ Flexbox –¥–ª—è –≤–µ—Ä—Å—Ç–∫–∏
5. –ê–Ω–∏–º–∞—Ü–∏–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã
-->
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="AI-—Å–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Å–µ—Ä–∏–∞–ª–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ Cosine Similarity">
  <title>Show Recommender | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å–µ—Ä–∏–∞–ª–æ–≤</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #e50914;
      --primary-dark: #b20710;
      --secondary-color: #141414;
      --accent-color: #f5c518;
      --text-color: #ffffff;
      --text-secondary: #b3b3b3;
      --bg-color: #141414;
      --card-bg: #1f1f1f;
      --card-hover: #2a2a2a;
      --border-color: #333333;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      --gradient: linear-gradient(135deg, #e50914 0%, #b20710 100%);
      --star-color: #f5c518;
      --star-empty: #555555;
    }

    [data-theme="light"] {
      --primary-color: #e50914;
      --primary-dark: #b20710;
      --secondary-color: #f5f5f5;
      --text-color: #141414;
      --text-secondary: #666666;
      --bg-color: #f5f5f5;
      --card-bg: #ffffff;
      --card-hover: #f0f0f0;
      --border-color: #e0e0e0;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      --star-empty: #cccccc;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s;
    }

    /* Header */
    .header {
      background: var(--gradient);
      padding: 1.5rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: white;
      text-decoration: none;
    }

    .logo i {
      font-size: 2rem;
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .control-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.3s;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Progress Bar */
    .progress-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .progress-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .progress-count {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .progress-bar {
      height: 8px;
      background: var(--border-color);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--gradient);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .progress-hint {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-top: 0.75rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .tab-btn {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      color: var(--text-color);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tab-btn:hover {
      border-color: var(--primary-color);
    }

    .tab-btn.active {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    /* Search and Filter */
    .search-filter {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.75rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text-color);
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .search-box i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
    }

    .genre-filter {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .year-filter {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .year-label,
    .year-separator {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .year-filter select {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      font-size: 0.85rem;
      transition: border-color 0.3s;
      min-width: 120px;
    }

    .year-filter select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .genre-btn {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s;
    }

    .genre-btn:hover,
    .genre-btn.active {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    /* Movies Grid */
    .movies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1.5rem;
    }

    .movie-card {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
      position: relative;
    }

    .movie-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    }

    .movie-card.rated {
      border: 3px solid var(--accent-color);
    }

    .movie-poster {
      width: 100%;
      aspect-ratio: 2/3;
      object-fit: cover;
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .movie-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .movie-poster .placeholder {
      color: var(--text-secondary);
      font-size: 3rem;
    }

    .movie-poster .placeholder-text {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--card-bg) 0%, #1a1a2e 100%);
      padding: 1rem;
      box-sizing: border-box;
      text-align: center;
    }

    .movie-poster .placeholder-text .title {
      color: var(--text-color);
      font-size: 0.9rem;
      font-weight: 600;
      line-height: 1.3;
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-height: 80%;
      overflow: hidden;
    }

    .movie-poster .placeholder-text .icon {
      color: var(--primary-color);
      font-size: 2rem;
      margin-bottom: 0.5rem;
      opacity: 0.7;
    }

    .movie-info {
      padding: 1rem;
    }

    .movie-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .movie-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .movie-genres {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .genre-tag {
      background: var(--border-color);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .user-rating {
      display: flex;
      justify-content: center;
      gap: 0.25rem;
      padding: 0.75rem;
      background: rgba(0, 0, 0, 0.3);
    }

    .star {
      font-size: 1.25rem;
      color: var(--star-empty);
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
    }

    .star:hover,
    .star.active {
      color: var(--star-color);
      transform: scale(1.2);
    }

    .star.hovered {
      color: var(--star-color);
    }

    /* Recommendations Section */
    .recommendations-section {
      margin-top: 3rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .section-title i {
      color: var(--primary-color);
    }

    .get-recommendations-btn {
      background: var(--gradient);
      border: none;
      color: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .get-recommendations-btn:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(229, 9, 20, 0.4);
    }

    .get-recommendations-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Recommendation Cards */
    .recommendation-card {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      gap: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .recommendation-card:hover {
      transform: translateX(8px);
      box-shadow: var(--shadow);
    }

    .recommendation-rank {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary-color);
      min-width: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .recommendation-poster {
      width: 80px;
      height: 120px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .recommendation-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .recommendation-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .recommendation-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .recommendation-meta {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .similarity-score {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .similarity-bar {
      flex: 1;
      max-width: 200px;
      height: 8px;
      background: var(--border-color);
      border-radius: 4px;
      overflow: hidden;
    }

    .similarity-fill {
      height: 100%;
      background: var(--gradient);
      border-radius: 4px;
    }

    .similarity-value {
      font-weight: 600;
      color: var(--primary-color);
      min-width: 50px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--text-color);
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--card-bg);
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.25rem;
      z-index: 10;
      transition: background 0.3s;
    }

    .modal-close:hover {
      background: var(--primary-color);
    }

    .modal-content {
      display: flex;
      gap: 2rem;
      padding: 2rem;
    }

    .modal-poster {
      width: 250px;
      flex-shrink: 0;
      border-radius: 12px;
      overflow: hidden;
    }

    .modal-poster img {
      width: 100%;
      aspect-ratio: 2/3;
      object-fit: cover;
    }

    .modal-info {
      flex: 1;
    }

    .modal-title {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .modal-meta {
      color: var(--text-secondary);
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .modal-description {
      line-height: 1.6;
      margin-bottom: 1.5rem;
      color: var(--text-secondary);
    }

    .modal-genres {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .modal-genre-tag {
      background: var(--primary-color);
      color: white;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
    }

    .modal-rating {
      margin-top: 1.5rem;
    }

    .modal-rating-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }

    .modal-stars {
      display: flex;
      gap: 0.5rem;
    }

    .modal-stars .star {
      font-size: 2rem;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4rem;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--border-color);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }

      .movies-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
      }

      .modal-content {
        flex-direction: column;
        padding: 1.5rem;
      }

      .modal-poster {
        width: 100%;
        max-width: 250px;
        margin: 0 auto;
      }

      .recommendation-card {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .search-filter {
        flex-direction: column;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .movie-card {
      animation: fadeIn 0.5s ease forwards;
    }

    .recommendation-card {
      animation: fadeIn 0.5s ease forwards;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <a href="#" class="logo">
        <i class="fas fa-film"></i>
        <span class="logo-text" data-i18n="logo">Show Recommender</span>
      </a>
      <div class="header-controls">
        <button class="control-btn" id="resetBtn" title="–°–±—Ä–æ—Å–∏—Ç—å –æ—Ü–µ–Ω–∫–∏">
          <i class="fas fa-redo"></i>
          <span data-i18n="reset">–°–±—Ä–æ—Å–∏—Ç—å</span>
        </button>
        <button class="control-btn" id="themeBtn">
          <i class="fas fa-moon"></i>
        </button>
        <button class="control-btn" id="langBtn">
          <i class="fas fa-globe"></i>
          <span>RU</span>
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Progress Section -->
    <section class="progress-section">
      <div class="progress-header">
        <h2 class="progress-title" data-i18n="progressTitle">–ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ü–µ–Ω–∫–∏</h2>
        <span class="progress-count"><span id="ratedCount">0</span> / <span id="minRatings">5</span></span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <p class="progress-hint" data-i18n="progressHint">
        –û—Ü–µ–Ω–∏—Ç–µ –º–∏–Ω–∏–º—É–º 5 —Å–µ—Ä–∏–∞–ª–æ–≤, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
      </p>
    </section>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="rate">
        <i class="fas fa-star"></i>
        <span data-i18n="tabRate">–û—Ü–µ–Ω–∏—Ç—å —Å–µ—Ä–∏–∞–ª—ã</span>
      </button>
      <button class="tab-btn" data-tab="recommendations">
        <i class="fas fa-magic"></i>
        <span data-i18n="tabRecommendations">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</span>
      </button>
      <button class="tab-btn" data-tab="rated">
        <i class="fas fa-check-circle"></i>
        <span data-i18n="tabRated">–û—Ü–µ–Ω—ë–Ω–Ω—ã–µ</span>
      </button>
    </div>

    <!-- Rate Tab -->
    <div id="rateTab" class="tab-content">
      <div class="search-filter">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" data-i18n-placeholder="searchPlaceholder"
                 placeholder="–ü–æ–∏—Å–∫ —Å–µ—Ä–∏–∞–ª–æ–≤...">
        </div>
        <div class="genre-filter" id="genreFilter"></div>
        <div class="year-filter">
          <span class="year-label" data-i18n="yearLabel">–ì–æ–¥</span>
          <select id="yearFrom" aria-label="–ì–æ–¥ –æ—Ç"></select>
          <span class="year-separator">‚Äî</span>
          <select id="yearTo" aria-label="–ì–æ–¥ –¥–æ"></select>
        </div>
      </div>
      <div class="movies-grid" id="moviesGrid"></div>
    </div>

    <!-- Recommendations Tab -->
    <div id="recommendationsTab" class="tab-content" style="display: none;">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-wand-magic-sparkles"></i>
          <span data-i18n="recommendationsTitle">–í–∞—à–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</span>
        </h2>
        <button class="get-recommendations-btn" id="getRecsBtn">
          <i class="fas fa-sparkles"></i>
          <span data-i18n="getRecommendations">–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</span>
        </button>
      </div>
      <div id="recommendationsList"></div>
    </div>

    <!-- Rated Tab -->
    <div id="ratedTab" class="tab-content" style="display: none;">
      <div class="movies-grid" id="ratedGrid"></div>
    </div>
  </main>

  <!-- Movie Modal -->
  <div class="modal-overlay" id="movieModal">
    <div class="modal">
      <button class="modal-close" id="modalClose">
        <i class="fas fa-times"></i>
      </button>
      <div class="modal-content" id="modalContent"></div>
    </div>
  </div>

  <script>
    /**
     * Show Recommender Application
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Cosine Similarity –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
     */

    // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–∏–∞–ª–æ–≤ –∏–∑ TVMaze
    let MOVIES_DATABASE = [];

    // –í—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∂–∞–Ω—Ä—ã
    let ALL_GENRES = [...new Set(MOVIES_DATABASE.flatMap(m => m.genres || []))].sort();

    const TVMAZE_API_BASE = "https://api.tvmaze.com/shows?page=";
    const TVMAZE_CACHE_KEY = "tvmazeShowsCache";
    const TVMAZE_CACHE_VERSION = 4;
    const TVMAZE_CACHE_TTL_MS = 6 * 60 * 60 * 1000;
    const TVMAZE_MAX_PAGE_PROBE = 512;
    const TVMAZE_RECENT_PAGES = 2;
    const GENRE_MAP = {
      "science-fiction": "sci-fi",
      "science fiction": "sci-fi",
      "sci-fi": "sci-fi",
      "sci fi": "sci-fi",
      "sports": "sport",
      "sport": "sport",
      "children": "family",
      "anime": "animation"
    };

    function normalizeGenre(genre) {
      if (!genre) return null;
      const normalized = genre.toLowerCase().trim();
      const slug = normalized.replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "");
      return GENRE_MAP[normalized] || GENRE_MAP[slug] || slug;
    }

    function slugifyTag(value) {
      if (!value) return null;
      return value
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    function mapShowToMovie(show) {
      const genres = (show.genres || [])
        .map(normalizeGenre)
        .filter(Boolean);
      const tags = [
        ...genres,
        show.type,
        show.language,
        show.status,
        show.network && show.network.name,
        show.webChannel && show.webChannel.name
      ]
        .map(slugifyTag)
        .filter(Boolean);

      return {
        id: show.id,
        title: show.name,
        titleRu: show.name,
        year: show.premiered ? show.premiered.slice(0, 4) : "‚Äî",
        premiered: show.premiered || "",
        genres,
        tags: tags.length ? tags : ["tv"],
        rating: typeof show.rating?.average === "number" ? show.rating.average : null,
        posterUrl: show.image?.medium || show.image?.original || ""
      };
    }

    function getPosterUrl(movie) {
      if (movie.posterUrl) return movie.posterUrl;
      return "";
    }

    function hasPoster(movie) {
      return Boolean(movie.posterUrl);
    }

    function renderPosterContent(movie, title) {
      if (hasPoster(movie)) {
        return `<img src="${movie.posterUrl}"
                     alt="${title}"
                     onerror="this.parentElement.innerHTML=createPlaceholderHTML('${escapeHtml(title)}')"
                     loading="lazy">`;
      }
      return `<div class="placeholder-text">
                <i class="fas fa-film icon"></i>
                <span class="title">${title}</span>
              </div>`;
    }

    function createPlaceholderHTML(title) {
      return "<div class=\"placeholder-text\"><i class=\"fas fa-film icon\"></i><span class=\"title\">" + title + "</span></div>";
    }

    function escapeHtml(text) {
      return text.replace(/"/g, "&quot;").replace(/'/g, "&#39;");
    }

    function formatRating(value) {
      const parsed = typeof value === "number" ? value : parseFloat(value);
      return Number.isFinite(parsed) && parsed > 0 ? parsed.toFixed(1) : "‚Äî";
    }

    function getReleaseTimestamp(movie) {
      if (movie.premiered) {
        const dateValue = Date.parse(movie.premiered);
        if (!Number.isNaN(dateValue)) {
          return dateValue;
        }
      }
      const yearValue = parseInt(movie.year, 10);
      if (Number.isFinite(yearValue)) {
        return Date.UTC(yearValue, 0, 1);
      }
      return 0;
    }

    function getRatedCount() {
      return MOVIES_DATABASE.reduce((count, movie) => {
        return count + (userRatings[movie.id] ? 1 : 0);
      }, 0);
    }

    function syncRatings() {
      const validIds = new Set(MOVIES_DATABASE.map(movie => movie.id));
      const cleaned = {};
      Object.entries(userRatings).forEach(([movieId, rating]) => {
        if (validIds.has(parseInt(movieId, 10))) {
          cleaned[movieId] = rating;
        }
      });
      if (Object.keys(cleaned).length !== Object.keys(userRatings).length) {
        userRatings = cleaned;
        localStorage.setItem("movieRatings", JSON.stringify(userRatings));
      }
    }

    function readShowsCache(allowStale = false) {
      try {
        const raw = localStorage.getItem(TVMAZE_CACHE_KEY);
        if (!raw) return null;
        const cached = JSON.parse(raw);
        if (!cached || cached.version !== TVMAZE_CACHE_VERSION) return null;
        if (!Array.isArray(cached.data) || typeof cached.timestamp !== "number") return null;
        if (!allowStale && Date.now() - cached.timestamp > TVMAZE_CACHE_TTL_MS) return null;
        return cached.data;
      } catch (error) {
        console.warn("Failed to read TVMaze cache.", error);
        return null;
      }
    }

    function writeShowsCache(data) {
      try {
        const payload = {
          version: TVMAZE_CACHE_VERSION,
          timestamp: Date.now(),
          data
        };
        localStorage.setItem(TVMAZE_CACHE_KEY, JSON.stringify(payload));
      } catch (error) {
        console.warn("Failed to write TVMaze cache.", error);
      }
    }

    function applyShowsData(movies) {
      if (!Array.isArray(movies) || movies.length === 0) return;
      MOVIES_DATABASE = movies;
      ALL_GENRES = [...new Set(MOVIES_DATABASE.flatMap(m => m.genres || []))].sort();

      if (currentGenreFilter && !ALL_GENRES.includes(currentGenreFilter)) {
        currentGenreFilter = null;
      }

      syncRatings();
      renderGenreFilter();
      renderYearFilter();
      renderMovies();
      updateProgress();

      const activeTab = document.querySelector(".tab-btn.active")?.dataset.tab;
      if (activeTab === "rated") {
        renderRatedMovies();
      } else if (activeTab === "recommendations") {
        getRecommendations();
      }
    }

    async function fetchShowsPage(page) {
      try {
        const response = await fetch(`${TVMAZE_API_BASE}${page}`);
        if (!response.ok) return null;
        const data = await response.json();
        if (!Array.isArray(data) || data.length === 0) return null;
        return data;
      } catch (error) {
        return null;
      }
    }

    async function findLastPage() {
      let lowPage = 0;
      let lowData = null;
      let highPage = 1;

      let data = await fetchShowsPage(highPage);
      if (!data) {
        return null;
      }

      lowPage = highPage;
      lowData = data;

      while (highPage < TVMAZE_MAX_PAGE_PROBE) {
        highPage *= 2;
        data = await fetchShowsPage(highPage);
        if (data) {
          lowPage = highPage;
          lowData = data;
        } else {
          break;
        }
      }

      if (highPage >= TVMAZE_MAX_PAGE_PROBE && data) {
        return { page: lowPage, data: lowData };
      }

      let left = lowPage + 1;
      let right = highPage - 1;

      while (left <= right) {
        const mid = Math.floor((left + right) / 2);
        const midData = await fetchShowsPage(mid);
        if (midData) {
          lowPage = mid;
          lowData = midData;
          left = mid + 1;
        } else {
          right = mid - 1;
        }
      }

      return lowData ? { page: lowPage, data: lowData } : null;
    }

    async function loadShows() {
      const cached = readShowsCache();
      if (cached) {
        applyShowsData(cached);
        return;
      }

      try {
        const lastPageResult = await findLastPage();
        if (!lastPageResult) {
          throw new Error("Failed to locate latest TVMaze page.");
        }

        const { page: lastPage, data: lastPageData } = lastPageResult;
        const collected = [];

        if (lastPageData) {
          collected.push(...lastPageData);
        }

        const startPage = Math.max(0, lastPage - (TVMAZE_RECENT_PAGES - 1));
        for (let page = lastPage - 1; page >= startPage; page--) {
          const pageData = await fetchShowsPage(page);
          if (pageData) {
            collected.push(...pageData);
          }
        }

        const mapped = collected.map(mapShowToMovie).filter(movie => movie.title);
        const deduped = Array.from(new Map(mapped.map(movie => [movie.id, movie])).values());

        if (deduped.length > 0) {
          writeShowsCache(deduped);
          applyShowsData(deduped);
        }
      } catch (error) {
        const stale = readShowsCache(true);
        if (stale) {
          applyShowsData(stale);
        }
        console.warn("Failed to load TVMaze shows, using cached/fallback list.", error);
      }
    }

    // –ü–µ—Ä–µ–≤–æ–¥—ã
    const translations = {
      ru: {
        logo: "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–æ—Ä —Å–µ—Ä–∏–∞–ª–æ–≤",
        reset: "–°–±—Ä–æ—Å–∏—Ç—å",
        progressTitle: "–ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ü–µ–Ω–∫–∏",
        progressHint: "–û—Ü–µ–Ω–∏—Ç–µ –º–∏–Ω–∏–º—É–º 5 —Å–µ—Ä–∏–∞–ª–æ–≤, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
        tabRate: "–û—Ü–µ–Ω–∏—Ç—å —Å–µ—Ä–∏–∞–ª—ã",
        tabRecommendations: "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
        tabRated: "–û—Ü–µ–Ω—ë–Ω–Ω—ã–µ",
        searchPlaceholder: "–ü–æ–∏—Å–∫ —Å–µ—Ä–∏–∞–ª–æ–≤...",
        yearLabel: "–ì–æ–¥",
        yearFrom: "–ì–æ–¥ –æ—Ç",
        yearTo: "–ì–æ–¥ –¥–æ",
        noResultsTitle: "–°–µ—Ä–∏–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã",
        noResultsHint: "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞",
        recommendationsTitle: "–í–∞—à–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
        getRecommendations: "–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
        emptyRated: "–í—ã –µ—â—ë –Ω–µ –æ—Ü–µ–Ω–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–∏–∞–ª–∞",
        emptyRatedHint: "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É \"–û—Ü–µ–Ω–∏—Ç—å —Å–µ—Ä–∏–∞–ª—ã\" –∏ –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫–∏",
        emptyRecommendations: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Ü–µ–Ω–æ–∫",
        emptyRecommendationsHint: "–û—Ü–µ–Ω–∏—Ç–µ –º–∏–Ω–∏–º—É–º 5 —Å–µ—Ä–∏–∞–ª–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π",
        similarity: "–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å",
        rateMovie: "–û—Ü–µ–Ω–∏—Ç–µ —Å–µ—Ä–∏–∞–ª",
        yourRating: "–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞",
        tagsLabel: "–¢–µ–≥–∏",
        allGenres: "–í—Å–µ",
        genres: {
          action: "–ë–æ–µ–≤–∏–∫",
          adventure: "–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è",
          animation: "–ê–Ω–∏–º–∞—Ü–∏—è",
          biography: "–ë–∏–æ–≥—Ä–∞—Ñ–∏—è",
          comedy: "–ö–æ–º–µ–¥–∏—è",
          crime: "–ö—Ä–∏–º–∏–Ω–∞–ª",
          drama: "–î—Ä–∞–º–∞",
          family: "–°–µ–º–µ–π–Ω—ã–π",
          fantasy: "–§—ç–Ω—Ç–µ–∑–∏",
          history: "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π",
          horror: "–£–∂–∞—Å—ã",
          music: "–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π",
          mystery: "–î–µ—Ç–µ–∫—Ç–∏–≤",
          romance: "–†–æ–º–∞–Ω—Ç–∏–∫–∞",
          "sci-fi": "–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞",
          sport: "–°–ø–æ—Ä—Ç",
          thriller: "–¢—Ä–∏–ª–ª–µ—Ä",
          war: "–í–æ–µ–Ω–Ω—ã–π",
          western: "–í–µ—Å—Ç–µ—Ä–Ω"
        }
      },
      en: {
        logo: "Show Recommender",
        reset: "Reset",
        progressTitle: "Rating Progress",
        progressHint: "Rate at least 5 shows to get personalized recommendations",
        tabRate: "Rate Shows",
        tabRecommendations: "Recommendations",
        tabRated: "Rated",
        searchPlaceholder: "Search shows...",
        yearLabel: "Year",
        yearFrom: "Year from",
        yearTo: "Year to",
        noResultsTitle: "No shows found",
        noResultsHint: "Try adjusting your search",
        recommendationsTitle: "Your Recommendations",
        getRecommendations: "Get Recommendations",
        emptyRated: "You haven't rated any shows yet",
        emptyRatedHint: "Go to 'Rate Shows' tab and rate some shows",
        emptyRecommendations: "Not enough ratings",
        emptyRecommendationsHint: "Rate at least 5 shows to get recommendations",
        similarity: "Match",
        rateMovie: "Rate this show",
        yourRating: "Your rating",
        tagsLabel: "Tags",
        allGenres: "All",
        genres: {
          action: "Action",
          adventure: "Adventure",
          animation: "Animation",
          biography: "Biography",
          comedy: "Comedy",
          crime: "Crime",
          drama: "Drama",
          family: "Family",
          fantasy: "Fantasy",
          history: "History",
          horror: "Horror",
          music: "Music",
          mystery: "Mystery",
          romance: "Romance",
          "sci-fi": "Sci-Fi",
          sport: "Sport",
          thriller: "Thriller",
          war: "War",
          western: "Western"
        }
      }
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let currentLang = localStorage.getItem("movieRecLang") || "ru";
    let currentTheme = localStorage.getItem("movieRecTheme") || "dark";
    let userRatings = JSON.parse(localStorage.getItem("movieRatings") || "{}");
    let currentGenreFilter = null;
    let currentSearchQuery = "";
    let currentYearFrom = localStorage.getItem("showYearFrom") || "";
    let currentYearTo = localStorage.getItem("showYearTo") || "";

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
     */
    function init() {
      applyTheme();
      applyLanguage();
      renderGenreFilter();
      renderYearFilter();
      renderMovies();
      updateProgress();
      setupEventListeners();
      loadShows();
    }

    /**
     * –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
     */
    function applyTheme() {
      document.body.setAttribute("data-theme", currentTheme);
      const icon = document.querySelector("#themeBtn i");
      icon.className = currentTheme === "dark" ? "fas fa-sun" : "fas fa-moon";
    }

    /**
     * –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —è–∑—ã–∫–∞
     */
    function applyLanguage() {
      const t = translations[currentLang];

      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.dataset.i18n;
        if (t[key]) el.textContent = t[key];
      });

      document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        const key = el.dataset.i18nPlaceholder;
        if (t[key]) el.placeholder = t[key];
      });

      document.querySelector("#langBtn span").textContent = currentLang.toUpperCase();
    }

    /**
     * –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –∂–∞–Ω—Ä–æ–≤
     */
    function renderGenreFilter() {
      const container = document.getElementById("genreFilter");
      const t = translations[currentLang];

      let html = `<button class="genre-btn ${!currentGenreFilter ? 'active' : ''}"
                          data-genre="">${t.allGenres}</button>`;

      ALL_GENRES.forEach(genre => {
        const genreName = t.genres[genre] || genre;
        html += `<button class="genre-btn ${currentGenreFilter === genre ? 'active' : ''}"
                         data-genre="${genre}">${genreName}</button>`;
      });

      container.innerHTML = html;
    }

    function persistYearFilters() {
      if (currentYearFrom) {
        localStorage.setItem("showYearFrom", currentYearFrom);
      } else {
        localStorage.removeItem("showYearFrom");
      }

      if (currentYearTo) {
        localStorage.setItem("showYearTo", currentYearTo);
      } else {
        localStorage.removeItem("showYearTo");
      }
    }

    function getAvailableYears() {
      const years = new Set();
      MOVIES_DATABASE.forEach(movie => {
        const yearValue = parseInt(movie.year, 10);
        if (Number.isFinite(yearValue)) {
          years.add(yearValue);
        }
      });
      return Array.from(years).sort((a, b) => b - a);
    }

    function renderYearFilter() {
      const fromSelect = document.getElementById("yearFrom");
      const toSelect = document.getElementById("yearTo");
      if (!fromSelect || !toSelect) return;

      const t = translations[currentLang];
      const years = getAvailableYears();
      const fromValue = parseInt(currentYearFrom, 10);
      const toValue = parseInt(currentYearTo, 10);

      if (Number.isFinite(fromValue) && !years.includes(fromValue)) {
        years.push(fromValue);
      }
      if (Number.isFinite(toValue) && !years.includes(toValue)) {
        years.push(toValue);
      }

      years.sort((a, b) => b - a);

      currentYearFrom = Number.isFinite(fromValue) ? String(fromValue) : "";
      currentYearTo = Number.isFinite(toValue) ? String(toValue) : "";

      if (currentYearFrom && currentYearTo && parseInt(currentYearFrom, 10) > parseInt(currentYearTo, 10)) {
        currentYearTo = currentYearFrom;
      }

      fromSelect.innerHTML = [
        `<option value="">${t.yearFrom}</option>`,
        ...years.map(year => `<option value="${year}">${year}</option>`)
      ].join("");

      toSelect.innerHTML = [
        `<option value="">${t.yearTo}</option>`,
        ...years.map(year => `<option value="${year}">${year}</option>`)
      ].join("");

      fromSelect.value = currentYearFrom;
      toSelect.value = currentYearTo;

      fromSelect.disabled = years.length === 0;
      toSelect.disabled = years.length === 0;
      fromSelect.setAttribute("aria-label", t.yearFrom);
      toSelect.setAttribute("aria-label", t.yearTo);

      persistYearFilters();
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å–º—ã
     */
    function getFilteredMovies() {
      return MOVIES_DATABASE.filter(movie => {
        // –§–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä—É
        if (currentGenreFilter && !(movie.genres || []).includes(currentGenreFilter)) {
          return false;
        }

        // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É
        if (currentSearchQuery) {
          const query = currentSearchQuery.toLowerCase();
          const title = (currentLang === "ru" ? (movie.titleRu || movie.title) : movie.title).toLowerCase();
          const tags = (movie.tags || []).join(" ").toLowerCase();
          const genres = (movie.genres || []).join(" ").toLowerCase();

          if (!title.includes(query) && !tags.includes(query) && !genres.includes(query)) {
            return false;
          }
        }

        if (currentYearFrom || currentYearTo) {
          const yearValue = parseInt(movie.year, 10);
          if (!Number.isFinite(yearValue)) {
            return false;
          }
          if (currentYearFrom && yearValue < parseInt(currentYearFrom, 10)) {
            return false;
          }
          if (currentYearTo && yearValue > parseInt(currentYearTo, 10)) {
            return false;
          }
        }

        return true;
      });
    }

    /**
     * –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ñ–∏–ª—å–º–æ–≤c
     */
    function renderMovies() {
      const container = document.getElementById("moviesGrid");
      const movies = getFilteredMovies()
        .slice()
        .sort((a, b) => getReleaseTimestamp(b) - getReleaseTimestamp(a));
      const t = translations[currentLang];

      if (movies.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <i class="fas fa-film"></i>
            <h3>${t.noResultsTitle}</h3>
            <p>${t.noResultsHint}</p>
          </div>
        `;
        return;
      }

      container.innerHTML = movies.map((movie, index) => {
        const title = currentLang === "ru" ? (movie.titleRu || movie.title) : movie.title;
        const rating = userRatings[movie.id] || 0;
        const displayRating = formatRating(movie.rating);

        return `
          <div class="movie-card ${rating > 0 ? 'rated' : ''}"
               data-id="${movie.id}"
               style="animation-delay: ${index * 0.05}s">
            <div class="movie-poster" onclick="openModal(${movie.id})">
              ${renderPosterContent(movie, title)}
            </div>
            <div class="movie-info">
              <h3 class="movie-title" onclick="openModal(${movie.id})">${title}</h3>
              <div class="movie-meta">
                <span>${movie.year}</span>
                <span>‚òÖ ${displayRating}</span>
              </div>
              <div class="movie-genres">
                ${movie.genres.slice(0, 2).map(g =>
                  `<span class="genre-tag">${t.genres[g] || g}</span>`
                ).join("")}
              </div>
            </div>
            <div class="user-rating">
              ${[1,2,3,4,5].map(star => `
                <span class="star ${star <= rating ? 'active' : ''}"
                      data-movie="${movie.id}"
                      data-star="${star}">‚òÖ</span>
              `).join("")}
            </div>
          </div>
        `;
      }).join("");
    }

    /**
     * –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ—Ü–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤
     */
    function renderRatedMovies() {
      const container = document.getElementById("ratedGrid");
      const t = translations[currentLang];

      const ratedMovies = MOVIES_DATABASE.filter(m => userRatings[m.id] > 0)
        .sort((a, b) => userRatings[b.id] - userRatings[a.id]);

      if (ratedMovies.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <i class="fas fa-star"></i>
            <h3>${t.emptyRated}</h3>
            <p>${t.emptyRatedHint}</p>
          </div>
        `;
        return;
      }

      container.innerHTML = ratedMovies.map((movie, index) => {
        const title = currentLang === "ru" ? (movie.titleRu || movie.title) : movie.title;
        const rating = userRatings[movie.id];
        const displayRating = formatRating(movie.rating);

        return `
          <div class="movie-card rated"
               data-id="${movie.id}"
               style="animation-delay: ${index * 0.05}s">
            <div class="movie-poster" onclick="openModal(${movie.id})">
              ${renderPosterContent(movie, title)}
            </div>
            <div class="movie-info">
              <h3 class="movie-title" onclick="openModal(${movie.id})">${title}</h3>
              <div class="movie-meta">
                <span>${movie.year}</span>
                <span>‚òÖ ${displayRating}</span>
              </div>
              <div class="movie-genres">
                ${movie.genres.slice(0, 2).map(g =>
                  `<span class="genre-tag">${t.genres[g] || g}</span>`
                ).join("")}
              </div>
            </div>
            <div class="user-rating">
              ${[1,2,3,4,5].map(star => `
                <span class="star ${star <= rating ? 'active' : ''}"
                      data-movie="${movie.id}"
                      data-star="${star}">‚òÖ</span>
              `).join("")}
            </div>
          </div>
        `;
      }).join("");
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–ª—è —Ñ–∏–ª—å–º–∞
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∂–∞–Ω—Ä—ã –∏ —Ç–µ–≥–∏ –∫–∞–∫ –ø—Ä–∏–∑–Ω–∞–∫–∏
     */
    function createFeatureVector(movie) {
      const allTags = [...new Set(MOVIES_DATABASE.flatMap(m => [...(m.genres || []), ...(m.tags || [])]))];
      const vector = new Array(allTags.length).fill(0);

      [...(movie.genres || []), ...(movie.tags || [])].forEach(feature => {
        const idx = allTags.indexOf(feature);
        if (idx !== -1) {
          vector[idx] = 1;
        }
      });

      return vector;
    }

    /**
     * Cosine Similarity —á–µ—Ä–µ–∑ dot product
     */
    function cosineSimilarity(vecA, vecB) {
      let dotProduct = 0;
      let magnitudeA = 0;
      let magnitudeB = 0;

      for (let i = 0; i < vecA.length; i++) {
        dotProduct += vecA[i] * vecB[i];
        magnitudeA += vecA[i] * vecA[i];
        magnitudeB += vecB[i] * vecB[i];
      }

      magnitudeA = Math.sqrt(magnitudeA);
      magnitudeB = Math.sqrt(magnitudeB);

      if (magnitudeA === 0 || magnitudeB === 0) return 0;

      return dotProduct / (magnitudeA * magnitudeB);
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ü–µ–Ω–æ–∫
     */
    function createUserProfile() {
      const allTags = [...new Set(MOVIES_DATABASE.flatMap(m => [...(m.genres || []), ...(m.tags || [])]))];
      const profile = new Array(allTags.length).fill(0);

      let totalWeight = 0;

      Object.entries(userRatings).forEach(([movieId, rating]) => {
        const movie = MOVIES_DATABASE.find(m => m.id === parseInt(movieId));
        if (!movie) return;

        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–µ–π—Ç–∏–Ω–≥ (1-5 -> -2 –¥–æ 2)
        const weight = rating - 3;
        totalWeight += Math.abs(weight);

        [...(movie.genres || []), ...(movie.tags || [])].forEach(feature => {
          const idx = allTags.indexOf(feature);
          if (idx !== -1) {
            profile[idx] += weight;
          }
        });
      });

      // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è
      if (totalWeight > 0) {
        for (let i = 0; i < profile.length; i++) {
          profile[i] /= totalWeight;
        }
      }

      return profile;
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
     */
    function getRecommendations() {
      const ratedCount = getRatedCount();
      const t = translations[currentLang];
      const container = document.getElementById("recommendationsList");

      if (ratedCount < 5) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-magic"></i>
            <h3>${t.emptyRecommendations}</h3>
            <p>${t.emptyRecommendationsHint}</p>
          </div>
        `;
        return;
      }

      const userProfile = createUserProfile();

      // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ö–æ–∂–µ—Å—Ç—å –¥–ª—è –≤—Å–µ—Ö –Ω–µ–æ—Ü–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤
      const recommendations = MOVIES_DATABASE
        .filter(movie => !userRatings[movie.id])
        .map(movie => {
          const movieVector = createFeatureVector(movie);
          const similarity = cosineSimilarity(userProfile, movieVector);
          return { movie, similarity };
        })
        .sort((a, b) => b.similarity - a.similarity)
        .slice(0, 10);

      container.innerHTML = recommendations.map((rec, index) => {
        const movie = rec.movie;
        const title = currentLang === "ru" ? (movie.titleRu || movie.title) : movie.title;
        const posterUrl = getPosterUrl(movie);
        const displayRating = formatRating(movie.rating);
        const similarityPercent = Math.round(rec.similarity * 100);

        return `
          <div class="recommendation-card" style="animation-delay: ${index * 0.1}s">
            <div class="recommendation-rank">#${index + 1}</div>
            <div class="recommendation-poster">
              <img src="${posterUrl}"
                   alt="${title}"
                   onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 80 120%22><rect fill=%22%23333%22 width=%2280%22 height=%22120%22/><text fill=%22%23666%22 x=%2240%22 y=%2260%22 text-anchor=%22middle%22 font-size=%2224%22>üé¨</text></svg>'"
                   loading="lazy">
            </div>
            <div class="recommendation-details">
              <h3 class="recommendation-title">${title}</h3>
              <div class="recommendation-meta">
                ${movie.year} ‚Ä¢ ‚òÖ ${displayRating} ‚Ä¢
                ${movie.genres.slice(0, 2).map(g => t.genres[g] || g).join(", ")}
              </div>
              <div class="similarity-score">
                <span>${t.similarity}:</span>
                <div class="similarity-bar">
                  <div class="similarity-fill" style="width: ${similarityPercent}%"></div>
                </div>
                <span class="similarity-value">${similarityPercent}%</span>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
     */
    function updateProgress() {
      const ratedCount = getRatedCount();
      const minRatings = 5;
      const progress = Math.min(100, (ratedCount / minRatings) * 100);

      document.getElementById("ratedCount").textContent = ratedCount;
      document.getElementById("minRatings").textContent = minRatings;
      document.getElementById("progressFill").style.width = `${progress}%`;

      const recsBtn = document.getElementById("getRecsBtn");
      recsBtn.disabled = ratedCount < minRatings;
    }

    /**
     * –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ü–µ–Ω–∫–∏ —Ñ–∏–ª—å–º—É
     */
    function rateMovie(movieId, rating) {
      if (userRatings[movieId] === rating) {
        delete userRatings[movieId];
      } else {
        userRatings[movieId] = rating;
      }

      localStorage.setItem("movieRatings", JSON.stringify(userRatings));
      updateProgress();

      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–≤—ë–∑–¥—ã –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ
      document.querySelectorAll(`.star[data-movie="${movieId}"]`).forEach(star => {
        const starValue = parseInt(star.dataset.star);
        star.classList.toggle("active", starValue <= (userRatings[movieId] || 0));
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å rated –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ
      const card = document.querySelector(`.movie-card[data-id="${movieId}"]`);
      if (card) {
        card.classList.toggle("rated", userRatings[movieId] > 0);
      }
    }

    /**
     * –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –¥–µ—Ç–∞–ª—è–º–∏ —Ñ–∏–ª—å–º–∞
     */
    function openModal(movieId) {
      const movie = MOVIES_DATABASE.find(m => m.id === movieId);
      if (!movie) return;

      const t = translations[currentLang];
      const title = currentLang === "ru" ? (movie.titleRu || movie.title) : movie.title;
      const rating = userRatings[movie.id] || 0;
      const posterUrl = getPosterUrl(movie);
      const displayRating = formatRating(movie.rating);
      const ratingLabel = displayRating === "‚Äî" ? "‚Äî" : `${displayRating}/10`;
      const tags = (movie.tags || []).join(", ");
      const tagsLabel = t.tagsLabel || "Tags";

      document.getElementById("modalContent").innerHTML = `
        <div class="modal-poster">
          <img src="${posterUrl}"
               alt="${title}"
               onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 250 375%22><rect fill=%22%23333%22 width=%22250%22 height=%22375%22/><text fill=%22%23666%22 x=%22125%22 y=%22187%22 text-anchor=%22middle%22 font-size=%2248%22>üé¨</text></svg>'">
        </div>
        <div class="modal-info">
          <h2 class="modal-title">${title}</h2>
          <div class="modal-meta">
            <span><i class="fas fa-calendar"></i> ${movie.year}</span>
            <span><i class="fas fa-star" style="color: var(--accent-color)"></i> ${ratingLabel}</span>
          </div>
          <div class="modal-genres">
            ${movie.genres.map(g =>
              `<span class="modal-genre-tag">${t.genres[g] || g}</span>`
            ).join("")}
          </div>
          <p class="modal-description">
            <strong>${tagsLabel}:</strong> ${tags || "‚Äî"}
          </p>
          <div class="modal-rating">
            <h4 class="modal-rating-title">${t.yourRating}</h4>
            <div class="modal-stars">
              ${[1,2,3,4,5].map(star => `
                <span class="star ${star <= rating ? 'active' : ''}"
                      data-movie="${movie.id}"
                      data-star="${star}">‚òÖ</span>
              `).join("")}
            </div>
          </div>
        </div>
      `;

      document.getElementById("movieModal").classList.add("active");
    }

    /**
     * –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
     */
    function closeModal() {
      document.getElementById("movieModal").classList.remove("active");
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
     */
    function switchTab(tabName) {
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tabName);
      });

      document.querySelectorAll(".tab-content").forEach(content => {
        content.style.display = "none";
      });

      document.getElementById(`${tabName}Tab`).style.display = "block";

      if (tabName === "rated") {
        renderRatedMovies();
      } else if (tabName === "recommendations") {
        getRecommendations();
      }
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
     */
    function setupEventListeners() {
      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
      document.getElementById("themeBtn").addEventListener("click", () => {
        currentTheme = currentTheme === "dark" ? "light" : "dark";
        localStorage.setItem("movieRecTheme", currentTheme);
        applyTheme();
      });

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞
      document.getElementById("langBtn").addEventListener("click", () => {
        currentLang = currentLang === "ru" ? "en" : "ru";
        localStorage.setItem("movieRecLang", currentLang);
        applyLanguage();
        renderGenreFilter();
        renderYearFilter();
        renderMovies();

        const activeTab = document.querySelector(".tab-btn.active").dataset.tab;
        if (activeTab === "rated") {
          renderRatedMovies();
        } else if (activeTab === "recommendations") {
          getRecommendations();
        }
      });

      // –°–±—Ä–æ—Å –æ—Ü–µ–Ω–æ–∫
      document.getElementById("resetBtn").addEventListener("click", () => {
        if (confirm(currentLang === "ru"
          ? "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –æ—Ü–µ–Ω–∫–∏?"
          : "Are you sure you want to reset all ratings?")) {
          userRatings = {};
          localStorage.removeItem("movieRatings");
          updateProgress();
          renderMovies();
          renderRatedMovies();
          getRecommendations();
        }
      });

      // –í–∫–ª–∞–¥–∫–∏
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => switchTab(btn.dataset.tab));
      });

      // –ü–æ–∏—Å–∫
      document.getElementById("searchInput").addEventListener("input", (e) => {
        currentSearchQuery = e.target.value;
        renderMovies();
      });

      // –§–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä–∞–º
      document.getElementById("genreFilter").addEventListener("click", (e) => {
        if (e.target.classList.contains("genre-btn")) {
          currentGenreFilter = e.target.dataset.genre || null;
          renderGenreFilter();
          renderMovies();
        }
      });

      // –§–∏–ª—å—Ç—Ä –ø–æ –≥–æ–¥–∞–º
      document.getElementById("yearFrom").addEventListener("change", (e) => {
        currentYearFrom = e.target.value;
        if (currentYearFrom && currentYearTo && parseInt(currentYearFrom, 10) > parseInt(currentYearTo, 10)) {
          currentYearTo = currentYearFrom;
          document.getElementById("yearTo").value = currentYearTo;
        }
        persistYearFilters();
        renderMovies();
      });

      document.getElementById("yearTo").addEventListener("change", (e) => {
        currentYearTo = e.target.value;
        if (currentYearFrom && currentYearTo && parseInt(currentYearTo, 10) < parseInt(currentYearFrom, 10)) {
          currentYearFrom = currentYearTo;
          document.getElementById("yearFrom").value = currentYearFrom;
        }
        persistYearFilters();
        renderMovies();
      });

      // –û—Ü–µ–Ω–∫–∞ —Ñ–∏–ª—å–º–æ–≤ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("star")) {
          const movieId = parseInt(e.target.dataset.movie);
          const starValue = parseInt(e.target.dataset.star);
          rateMovie(movieId, starValue);
        }
      });

      // Hover —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∑–≤—ë–∑–¥
      document.addEventListener("mouseover", (e) => {
        if (e.target.classList.contains("star")) {
          const movieId = e.target.dataset.movie;
          const starValue = parseInt(e.target.dataset.star);

          document.querySelectorAll(`.star[data-movie="${movieId}"]`).forEach(star => {
            const sv = parseInt(star.dataset.star);
            star.classList.toggle("hovered", sv <= starValue);
          });
        }
      });

      document.addEventListener("mouseout", (e) => {
        if (e.target.classList.contains("star")) {
          const movieId = e.target.dataset.movie;
          document.querySelectorAll(`.star[data-movie="${movieId}"]`).forEach(star => {
            star.classList.remove("hovered");
          });
        }
      });

      // –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
      document.getElementById("getRecsBtn").addEventListener("click", getRecommendations);

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      document.getElementById("modalClose").addEventListener("click", closeModal);
      document.getElementById("movieModal").addEventListener("click", (e) => {
        if (e.target.id === "movieModal") closeModal();
      });

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
