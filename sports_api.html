<!doctype html>
<!--
ТЕХНИЧЕСКОЕ ЗАДАНИЕ

Цель: Создать интерактивную страницу для просмотра спортивной статистики с использованием TheSportsDB API.

Функциональные требования:
1. Выбор вида спорта:
   - Отображение списка доступных видов спорта
   - Иконки для каждого вида спорта
   - Фильтрация лиг по выбранному спорту

2. Просмотр лиг:
   - Список лиг выбранного вида спорта
   - Логотипы лиг
   - Страна проведения

3. Просмотр команд:
   - Список команд выбранной лиги
   - Эмблемы команд
   - Основная информация о команде

4. Поиск:
   - Поиск команд по названию
   - Автодополнение результатов
   - Переход к детальной информации

5. Детальная информация о команде:
   - Название и эмблема
   - Стадион
   - Год основания
   - Описание
   - Социальные сети

6. Пользовательский интерфейс:
   - Темная/светлая тема
   - Адаптивный дизайн
   - Анимации загрузки
   - Кэширование данных

Технические требования:
1. TheSportsDB API (бесплатный ключ 3)
2. LocalStorage для кэширования и настроек
3. CSS переменные для темизации
4. Font Awesome для иконок
-->

<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Спортивная статистика</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      :root {
        --bg-color: #f0f4f8;
        --card-bg: #ffffff;
        --text-color: #1a1a2e;
        --text-secondary: #4a4a6a;
        --border-color: #e0e4e8;
        --primary-color: #2ecc71;
        --primary-hover: #27ae60;
        --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
        --gradient-start: #a8e6cf;
        --gradient-end: #3d9970;
        --input-bg: #ffffff;
        --input-border: #d0e4e0;
        --accent-color: #e74c3c;
      }

      [data-theme="dark"] {
        --bg-color: #1a1a2e;
        --card-bg: #252540;
        --text-color: #e8e8e8;
        --text-secondary: #a0a0b0;
        --border-color: #3a3a5a;
        --primary-color: #2ecc71;
        --primary-hover: #27ae60;
        --shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.4);
        --gradient-start: #1e3a2f;
        --gradient-end: #1a1a2e;
        --input-bg: #2d2d4a;
        --input-border: #3a3a5a;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, sans-serif;
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        min-height: 100vh;
        color: var(--text-color);
        transition: background 0.3s ease, color 0.3s ease;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Шапка */
      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.2rem;
        color: var(--text-color);
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header p {
        color: var(--text-secondary);
        font-size: 1rem;
      }

      /* Навигация */
      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .breadcrumb-item {
        color: var(--text-secondary);
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .breadcrumb-item:hover,
      .breadcrumb-item:focus {
        color: var(--primary-color);
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
        border-radius: 4px;
      }

      .breadcrumb-item.active {
        color: var(--text-color);
        font-weight: 600;
        cursor: default;
      }

      .breadcrumb-separator {
        color: var(--text-secondary);
      }

      /* Поиск */
      .search-container {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 30px;
        position: relative;
      }

      .search-wrapper {
        position: relative;
        width: 400px;
        max-width: 100%;
      }

      .search-input {
        padding: 12px 20px;
        font-size: 1rem;
        border: 2px solid var(--input-border);
        border-radius: 30px;
        background: var(--input-bg);
        color: var(--text-color);
        width: 100%;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 10px rgba(46, 204, 113, 0.3);
      }

      .search-input::placeholder {
        color: var(--text-secondary);
      }

      .search-btn {
        padding: 12px 24px;
        font-size: 1rem;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--primary-color);
        color: white;
      }

      .search-btn:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
      }

      /* Автодополнение */
      .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--card-bg);
        border-radius: 15px;
        box-shadow: var(--shadow);
        max-height: 300px;
        overflow-y: auto;
        z-index: 100;
        display: none;
        margin-top: 5px;
      }

      .autocomplete-results.active {
        display: block;
      }

      .autocomplete-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        cursor: pointer;
        transition: background 0.2s ease;
        border-bottom: 1px solid var(--border-color);
      }

      .autocomplete-item:last-child {
        border-bottom: none;
      }

      .autocomplete-item:hover,
      .autocomplete-item:focus {
        background: var(--border-color);
        outline: 2px solid var(--primary-color);
        outline-offset: -2px;
      }

      .autocomplete-item img {
        width: 30px;
        height: 30px;
        object-fit: contain;
      }

      /* Грид спортов/лиг/команд */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .grid-large {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      }

      .card {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .card:hover,
      .card:focus {
        transform: translateY(-5px);
        box-shadow: var(--shadow-hover);
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
      }

      .card:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
      }

      .card-icon {
        font-size: 3rem;
        color: var(--primary-color);
      }

      .card-image {
        width: 80px;
        height: 80px;
        object-fit: contain;
        border-radius: 10px;
      }

      .card-image-large {
        width: 120px;
        height: 120px;
      }

      .card-title {
        font-weight: 600;
        color: var(--text-color);
        font-size: 1rem;
      }

      .card-subtitle {
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      /* Детальная информация о команде */
      .team-detail {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 30px;
        box-shadow: var(--shadow);
        display: none;
      }

      .team-detail.active {
        display: block;
      }

      .team-header {
        display: flex;
        align-items: center;
        gap: 30px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .team-badge {
        width: 150px;
        height: 150px;
        object-fit: contain;
      }

      .team-info h2 {
        font-size: 2rem;
        margin-bottom: 10px;
        color: var(--text-color);
      }

      .team-info .team-alt-name {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-bottom: 10px;
      }

      .team-meta {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 15px;
      }

      .team-meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
      }

      .team-meta-item i {
        color: var(--primary-color);
      }

      .team-description {
        line-height: 1.8;
        color: var(--text-secondary);
        margin-bottom: 20px;
      }

      .team-social {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .social-link {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: var(--border-color);
        color: var(--text-color);
        text-decoration: none;
        transition: all 0.3s ease;
        font-size: 1.2rem;
      }

      .social-link:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-3px);
      }

      /* Стадион */
      .stadium-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
      }

      .stadium-section h3 {
        margin-bottom: 15px;
        color: var(--text-color);
      }

      .stadium-info {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
      }

      .stadium-image {
        width: 200px;
        height: 130px;
        object-fit: cover;
        border-radius: 10px;
      }

      .stadium-details {
        flex: 1;
        min-width: 200px;
      }

      .stadium-details h4 {
        color: var(--text-color);
        margin-bottom: 5px;
      }

      .stadium-details p {
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      /* Форма команды */
      .jersey-section {
        margin-top: 20px;
      }

      .jersey-section h3 {
        margin-bottom: 15px;
        color: var(--text-color);
      }

      .jerseys {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }

      .jersey-item {
        text-align: center;
      }

      .jersey-image {
        width: 80px;
        height: 100px;
        object-fit: contain;
      }

      .jersey-label {
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin-top: 5px;
      }

      /* Кнопка настроек */
      .settings-button {
        position: fixed;
        top: 20px;
        right: 20px;
        font-size: 24px;
        color: var(--text-color);
        background-color: var(--card-bg);
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: var(--shadow);
        z-index: 1000;
        transition: all 0.3s ease;
        border: 2px solid var(--border-color);
      }

      .settings-button:hover {
        transform: rotate(45deg);
      }

      /* Модальное окно настроек */
      .settings-modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .settings-modal-content {
        background-color: var(--card-bg);
        margin: 15% auto;
        padding: 25px;
        border-radius: 15px;
        width: 320px;
        max-width: 90%;
        box-shadow: var(--shadow-hover);
      }

      .settings-modal h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: var(--text-color);
      }

      .settings-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 15px 0;
      }

      .settings-option label {
        color: var(--text-color);
        cursor: pointer;
        user-select: none;
        flex: 1;
        padding: 5px 0;
      }

      .toggle-switch {
        position: relative;
        width: 50px;
        height: 24px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--primary-color);
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      .close-settings {
        color: var(--text-color);
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
      }

      .close-settings:hover {
        opacity: 0.7;
      }

      /* Загрузка */
      .loading {
        display: none;
        text-align: center;
        padding: 50px;
      }

      .loading.active {
        display: block;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Ошибка */
      .error-message {
        display: none;
        text-align: center;
        padding: 30px;
        background: var(--card-bg);
        border-radius: 15px;
        color: #e74c3c;
      }

      .error-message.active {
        display: block;
      }

      .error-message i {
        font-size: 3rem;
        margin-bottom: 15px;
      }

      /* Пустое состояние */
      .empty-state {
        text-align: center;
        padding: 50px;
        color: var(--text-secondary);
      }

      .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      /* Кнопка назад */
      .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: var(--card-bg);
        color: var(--text-color);
        border: 2px solid var(--border-color);
        border-radius: 30px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        margin-bottom: 20px;
      }

      .back-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
      }

      /* Секция контента */
      .content-section {
        display: none;
      }

      .content-section.active {
        display: block;
      }

      /* Атрибуция */
      .attribution {
        text-align: center;
        margin-top: 30px;
        padding: 15px;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .attribution a {
        color: var(--primary-color);
        text-decoration: none;
      }

      .attribution a:hover {
        text-decoration: underline;
      }

      /* Иконки спортов */
      .sport-icon {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: var(--primary-color);
        background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(46, 204, 113, 0.2));
        border-radius: 50%;
      }

      /* Адаптивность */
      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.8rem;
        }

        .team-header {
          flex-direction: column;
          text-align: center;
        }

        .team-info h2 {
          font-size: 1.5rem;
        }

        .team-meta {
          justify-content: center;
        }

        .settings-button {
          top: 15px;
          right: 15px;
          width: 40px;
          height: 40px;
          font-size: 20px;
        }

        .grid {
          grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        }

        .search-wrapper {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        .grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .stadium-info {
          flex-direction: column;
        }

        .stadium-image {
          width: 100%;
          height: 150px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Кнопка настроек -->
    <button class="settings-button" id="settingsButton">
      <i class="fas fa-cog"></i>
    </button>

    <!-- Модальное окно настроек -->
    <div id="settingsModal" class="settings-modal">
      <div class="settings-modal-content">
        <span class="close-settings" id="closeSettings">&times;</span>
        <h3>Настройки</h3>
        <div class="settings-option">
          <label for="themeSwitch">Темная тема</label>
          <div class="toggle-switch">
            <input type="checkbox" id="themeSwitch" />
            <span class="slider"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <h1><i class="fas fa-trophy"></i> Спортивная статистика</h1>
        <p>Информация о спортивных лигах и командах</p>
      </div>

      <!-- Навигация -->
      <div class="breadcrumb" id="breadcrumb">
        <span class="breadcrumb-item active">Виды спорта</span>
      </div>

      <!-- Поиск -->
      <div class="search-container">
        <div class="search-wrapper">
          <input
            type="text"
            class="search-input"
            id="searchInput"
            placeholder="Поиск команды..."
            autocomplete="off"
          />
          <div class="autocomplete-results" id="autocompleteResults"></div>
        </div>
        <button class="search-btn" id="searchBtn">
          <i class="fas fa-search"></i> Найти
        </button>
      </div>

      <!-- Загрузка -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Загрузка данных...</p>
      </div>

      <!-- Ошибка -->
      <div class="error-message" id="errorMessage">
        <i class="fas fa-exclamation-circle"></i>
        <p id="errorText">Произошла ошибка</p>
      </div>

      <!-- Виды спорта -->
      <div class="content-section active" id="sportsSection">
        <div class="grid" id="sportsGrid"></div>
      </div>

      <!-- Лиги -->
      <div class="content-section" id="leaguesSection">
        <button class="back-btn" id="backToSports">
          <i class="fas fa-arrow-left"></i> К видам спорта
        </button>
        <div class="grid grid-large" id="leaguesGrid"></div>
      </div>

      <!-- Команды -->
      <div class="content-section" id="teamsSection">
        <button class="back-btn" id="backToLeagues">
          <i class="fas fa-arrow-left"></i> К лигам
        </button>
        <div class="grid grid-large" id="teamsGrid"></div>
      </div>

      <!-- Детали команды -->
      <div class="content-section" id="teamDetailSection">
        <button class="back-btn" id="backToTeams">
          <i class="fas fa-arrow-left"></i> К командам
        </button>
        <div class="team-detail active" id="teamDetail"></div>
      </div>

      <!-- Атрибуция -->
      <div class="attribution">
        Данные предоставлены <a href="https://www.thesportsdb.com/" target="_blank">TheSportsDB</a>
      </div>
    </div>

    <script>
      // === КОНСТАНТЫ ===
      const API_BASE = 'https://www.thesportsdb.com/api/v1/json/3';
      const CACHE_TTL = 30 * 60 * 1000; // 30 минут

      // Иконки для видов спорта
      const sportIcons = {
        // Командные виды спорта
        'Soccer': 'fa-futbol',
        'Football': 'fa-football',
        'American Football': 'fa-football',
        'Basketball': 'fa-basketball',
        'Ice Hockey': 'fa-hockey-puck',
        'Baseball': 'fa-baseball',
        'Cricket': 'fa-baseball',
        'Rugby': 'fa-football',
        'Volleyball': 'fa-volleyball',
        'Handball': 'fa-hand-dots',
        'Field Hockey': 'fa-hockey-puck',
        'Netball': 'fa-basketball',
        'Australian Football': 'fa-football',
        'Aussie Rules': 'fa-football',
        'GAA Football': 'fa-football',
        'Gaelic Football': 'fa-football',
        'Hurling': 'fa-hockey-puck',
        'Lacrosse': 'fa-hockey-puck',
        'Water Polo': 'fa-water',
        'Beach Volleyball': 'fa-volleyball',
        'Bandy': 'fa-hockey-puck',
        'Floorball': 'fa-hockey-puck',
        'Futsal': 'fa-futbol',

        // Ракеточные виды спорта
        'Tennis': 'fa-table-tennis-paddle-ball',
        'Table Tennis': 'fa-table-tennis-paddle-ball',
        'Badminton': 'fa-shuttlecock',
        'Squash': 'fa-table-tennis-paddle-ball',
        'Padel': 'fa-table-tennis-paddle-ball',
        'Pickleball': 'fa-table-tennis-paddle-ball',

        // Индивидуальные виды спорта
        'Golf': 'fa-golf-ball-tee',
        'Swimming': 'fa-person-swimming',
        'Athletics': 'fa-person-running',
        'Cycling': 'fa-bicycle',
        'Triathlon': 'fa-person-biking',
        'Running': 'fa-person-running',
        'Marathon': 'fa-person-running',

        // Единоборства
        'Boxing': 'fa-hand-fist',
        'MMA': 'fa-hand-fist',
        'Fighting': 'fa-hand-fist',
        'Wrestling': 'fa-hand-fist',
        'Judo': 'fa-user-ninja',
        'Karate': 'fa-user-ninja',
        'Taekwondo': 'fa-user-ninja',
        'Kickboxing': 'fa-hand-fist',
        'Muay Thai': 'fa-hand-fist',
        'Sumo': 'fa-hand-fist',
        'Fencing': 'fa-slash',

        // Моторные виды спорта
        'Motorsport': 'fa-car',
        'Formula 1': 'fa-flag-checkered',
        'NASCAR': 'fa-car-side',
        'MotoGP': 'fa-motorcycle',
        'Rallying': 'fa-car',
        'IndyCar': 'fa-car',
        'Superbikes': 'fa-motorcycle',
        'Motocross': 'fa-motorcycle',
        'Drag Racing': 'fa-car',

        // Водные виды спорта
        'Sailing': 'fa-sailboat',
        'Rowing': 'fa-person-swimming',
        'Canoeing': 'fa-ship',
        'Kayaking': 'fa-ship',
        'Surfing': 'fa-water',
        'Diving': 'fa-water',
        'Synchronized Swimming': 'fa-person-swimming',

        // Зимние виды спорта
        'Skiing': 'fa-person-skiing',
        'Alpine Skiing': 'fa-person-skiing',
        'Cross-Country Skiing': 'fa-person-skiing-nordic',
        'Snowboarding': 'fa-snowflake',
        'Biathlon': 'fa-person-skiing-nordic',
        'Bobsled': 'fa-sled',
        'Figure Skating': 'fa-ice-skate',
        'Speed Skating': 'fa-circle-notch',
        'Curling': 'fa-bullseye',
        'Ski Jumping': 'fa-person-skiing',
        'Luge': 'fa-sled',

        // Киберспорт
        'ESports': 'fa-gamepad',
        'Esports': 'fa-gamepad',

        // Прицельные виды спорта
        'Darts': 'fa-bullseye',
        'Snooker': 'fa-circle',
        'Pool': 'fa-circle',
        'Billiards': 'fa-circle',
        'Bowling': 'fa-bowling-ball',
        'Archery': 'fa-bullseye',
        'Shooting': 'fa-crosshairs',

        // Другие виды спорта
        'Equestrian': 'fa-horse',
        'Horse Racing': 'fa-horse',
        'Gymnastics': 'fa-person',
        'Weightlifting': 'fa-dumbbell',
        'Powerlifting': 'fa-dumbbell',
        'Skateboarding': 'fa-skateboard',
        'BMX': 'fa-bicycle',
        'Climbing': 'fa-mountain',
        'Rock Climbing': 'fa-mountain',
        'Fishing': 'fa-fish',
        'Poker': 'fa-spade',
        'Chess': 'fa-chess',
        'Dog Racing': 'fa-dog',
        'Greyhound': 'fa-dog',
        'Polo': 'fa-horse',
        'Speedway': 'fa-motorcycle',
        'Supercars': 'fa-car',
        'Touring Car': 'fa-car',
        'Softball': 'fa-baseball',
        'Beach Soccer': 'fa-futbol',

        'default': 'fa-trophy'
      };

      // Состояние приложения
      const state = {
        currentSport: null,
        currentLeague: null,
        currentTeam: null,
        sports: [],
        leagues: [],
        teams: []
      };

      // === КЕШИРОВАНИЕ ===
      const cache = {
        get(key) {
          const item = localStorage.getItem('sports_cache_' + key);
          if (!item) return null;
          try {
            const parsed = JSON.parse(item);
            if (parsed.timestamp && Date.now() - parsed.timestamp < CACHE_TTL) {
              return parsed.data;
            }
            localStorage.removeItem('sports_cache_' + key);
            return null;
          } catch (e) {
            return null;
          }
        },
        set(key, data) {
          try {
            localStorage.setItem(
              'sports_cache_' + key,
              JSON.stringify({ timestamp: Date.now(), data })
            );
          } catch (e) {
            // Ошибка квоты localStorage или другая ошибка записи
            console.warn('Не удалось сохранить данные в localStorage (квота превышена или другая ошибка):', e);
          }
        }
      };

      // === API ФУНКЦИИ ===
      async function fetchAPI(endpoint, signal = null) {
        const cacheKey = endpoint.replace(/[^a-zA-Z0-9]/g, '_');
        let data = cache.get(cacheKey);
        if (data) return data;

        const response = await fetch(`${API_BASE}/${endpoint}`, { signal });
        if (!response.ok) {
          throw new Error('Ошибка загрузки данных');
        }
        data = await response.json();
        cache.set(cacheKey, data);
        return data;
      }

      async function getAllSports() {
        const data = await fetchAPI('all_sports.php');
        return data.sports || [];
      }

      async function getLeaguesBySport(sport) {
        const data = await fetchAPI(`search_all_leagues.php?s=${encodeURIComponent(sport)}`);
        return data.countries || [];
      }

      async function getTeamsByLeague(league) {
        const data = await fetchAPI(`search_all_teams.php?l=${encodeURIComponent(league)}`);
        return data.teams || [];
      }

      async function searchTeams(query, signal = null) {
        const data = await fetchAPI(`searchteams.php?t=${encodeURIComponent(query)}`, signal);
        return data.teams || [];
      }

      async function getTeamById(id) {
        const data = await fetchAPI(`lookupteam.php?id=${id}`);
        return data.teams ? data.teams[0] : null;
      }

      // === UI ФУНКЦИИ ===
      function showLoading() {
        document.getElementById('loading').classList.add('active');
        hideAllSections();
        document.getElementById('errorMessage').classList.remove('active');
      }

      function hideLoading() {
        document.getElementById('loading').classList.remove('active');
      }

      function showError(message) {
        hideLoading();
        document.getElementById('errorText').textContent = message;
        document.getElementById('errorMessage').classList.add('active');
        hideAllSections();
      }

      function hideAllSections() {
        document.querySelectorAll('.content-section').forEach(section => {
          section.classList.remove('active');
        });
      }

      function showSection(sectionId) {
        hideLoading();
        document.getElementById('errorMessage').classList.remove('active');
        hideAllSections();
        document.getElementById(sectionId).classList.add('active');
      }

      function getSportIcon(sportName) {
        return sportIcons[sportName] || sportIcons.default;
      }

      function updateBreadcrumb(items) {
        const breadcrumb = document.getElementById('breadcrumb');
        breadcrumb.innerHTML = items.map((item, index) => {
          const isLast = index === items.length - 1;
          const separator = index > 0
            ? '<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>'
            : '';
          const className = isLast ? 'breadcrumb-item active' : 'breadcrumb-item';
          const onclick = isLast ? '' : `onclick="${item.onclick}"`;
          return `${separator}<span class="${className}" ${onclick}>${item.label}</span>`;
        }).join('');
      }

      // === ОТОБРАЖЕНИЕ ДАННЫХ ===
      function renderSports(sports) {
        const grid = document.getElementById('sportsGrid');

        if (!sports || sports.length === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-search"></i>
              <p>Виды спорта не найдены</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = sports.map(sport => `
          <div class="card" onclick="selectSport('${sport.strSport}')">
            <div class="sport-icon">
              <i class="fas ${getSportIcon(sport.strSport)}"></i>
            </div>
            <div class="card-title">${sport.strSport}</div>
            <div class="card-subtitle">${sport.strFormat || ''}</div>
          </div>
        `).join('');
      }

      function renderLeagues(leagues) {
        const grid = document.getElementById('leaguesGrid');

        if (!leagues || leagues.length === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-search"></i>
              <p>Лиги не найдены для данного вида спорта</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = leagues.map(league => `
          <div class="card" onclick="selectLeague('${escapeHtml(league.strLeague)}')">
            ${league.strBadge
              ? `<img src="${league.strBadge}" alt="${league.strLeague}" class="card-image"
                   onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                 <div class="sport-icon" style="display:none;">
                   <i class="fas fa-trophy"></i>
                 </div>`
              : `<div class="sport-icon"><i class="fas fa-trophy"></i></div>`
            }
            <div class="card-title">${league.strLeague}</div>
            <div class="card-subtitle">${league.strCountry || ''}</div>
          </div>
        `).join('');
      }

      function renderTeams(teams) {
        const grid = document.getElementById('teamsGrid');

        if (!teams || teams.length === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-users"></i>
              <p>Команды не найдены для данной лиги</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = teams.map(team => `
          <div class="card" onclick="selectTeam('${team.idTeam}')">
            ${team.strBadge
              ? `<img src="${team.strBadge}" alt="${team.strTeam}" class="card-image card-image-large"
                   onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                 <div class="sport-icon" style="display:none;">
                   <i class="fas fa-shield-halved"></i>
                 </div>`
              : `<div class="sport-icon"><i class="fas fa-shield-halved"></i></div>`
            }
            <div class="card-title">${team.strTeam}</div>
            <div class="card-subtitle">${team.strStadium || ''}</div>
          </div>
        `).join('');
      }

      function renderTeamDetail(team) {
        const container = document.getElementById('teamDetail');

        if (!team) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-circle"></i>
              <p>Информация о команде не найдена</p>
            </div>
          `;
          return;
        }

        const socialLinks = [];
        if (team.strWebsite) {
          socialLinks.push(`
            <a href="${createSocialUrl(team.strWebsite)}" target="_blank" class="social-link" title="Веб-сайт">
              <i class="fas fa-globe"></i>
            </a>
          `);
        }
        if (team.strFacebook) {
          socialLinks.push(`
            <a href="${createSocialUrl(team.strFacebook)}" target="_blank" class="social-link" title="Facebook">
              <i class="fab fa-facebook-f"></i>
            </a>
          `);
        }
        if (team.strTwitter) {
          socialLinks.push(`
            <a href="${createSocialUrl(team.strTwitter)}" target="_blank" class="social-link" title="Twitter">
              <i class="fab fa-twitter"></i>
            </a>
          `);
        }
        if (team.strInstagram) {
          socialLinks.push(`
            <a href="${createSocialUrl(team.strInstagram)}" target="_blank" class="social-link" title="Instagram">
              <i class="fab fa-instagram"></i>
            </a>
          `);
        }
        if (team.strYoutube) {
          socialLinks.push(`
            <a href="${createSocialUrl(team.strYoutube)}" target="_blank" class="social-link" title="YouTube">
              <i class="fab fa-youtube"></i>
            </a>
          `);
        }

        // Описание на русском или английском
        const description = team.strDescriptionRU || team.strDescriptionEN || '';
        const shortDescription = description.length > 500
          ? description.substring(0, 500) + '...'
          : description;

        container.innerHTML = `
          <div class="team-header">
            ${team.strBadge
              ? `<img src="${team.strBadge}" alt="${team.strTeam}" class="team-badge">`
              : `<div class="sport-icon" style="width:150px;height:150px;font-size:4rem;">
                   <i class="fas fa-shield-halved"></i>
                 </div>`
            }
            <div class="team-info">
              <h2>${team.strTeam}</h2>
              ${team.strTeamAlternate
                ? `<p class="team-alt-name">${team.strTeamAlternate}</p>`
                : ''
              }
              <div class="team-meta">
                ${team.intFormedYear
                  ? `<div class="team-meta-item">
                       <i class="fas fa-calendar"></i>
                       <span>Основан: ${team.intFormedYear}</span>
                     </div>`
                  : ''
                }
                ${team.strCountry
                  ? `<div class="team-meta-item">
                       <i class="fas fa-globe"></i>
                       <span>${team.strCountry}</span>
                     </div>`
                  : ''
                }
                ${team.strLeague
                  ? `<div class="team-meta-item">
                       <i class="fas fa-trophy"></i>
                       <span>${team.strLeague}</span>
                     </div>`
                  : ''
                }
              </div>
            </div>
          </div>

          ${shortDescription
            ? `<p class="team-description">${shortDescription}</p>`
            : ''
          }

          ${socialLinks.length > 0
            ? `<div class="team-social">${socialLinks.join('')}</div>`
            : ''
          }

          ${team.strStadium
            ? `<div class="stadium-section">
                 <h3><i class="fas fa-building"></i> Стадион</h3>
                 <div class="stadium-info">
                   ${team.strStadiumThumb
                     ? `<img src="${team.strStadiumThumb}" alt="${team.strStadium}" class="stadium-image"
                          onerror="this.style.display='none'">`
                     : ''
                   }
                   <div class="stadium-details">
                     <h4>${team.strStadium}</h4>
                     ${team.strStadiumLocation
                       ? `<p><i class="fas fa-location-dot"></i> ${team.strStadiumLocation}</p>`
                       : ''
                     }
                     ${team.intStadiumCapacity
                       ? `<p><i class="fas fa-users"></i> Вместимость: ${parseInt(team.intStadiumCapacity).toLocaleString()}</p>`
                       : ''
                     }
                   </div>
                 </div>
               </div>`
            : ''
          }

          ${(team.strEquipment || team.strEquipmentAlt)
            ? `<div class="jersey-section">
                 <h3><i class="fas fa-shirt"></i> Форма</h3>
                 <div class="jerseys">
                   ${team.strEquipment
                     ? `<div class="jersey-item">
                          <img src="${team.strEquipment}" alt="Домашняя форма" class="jersey-image">
                          <p class="jersey-label">Домашняя</p>
                        </div>`
                     : ''
                   }
                   ${team.strEquipmentAlt
                     ? `<div class="jersey-item">
                          <img src="${team.strEquipmentAlt}" alt="Гостевая форма" class="jersey-image">
                          <p class="jersey-label">Гостевая</p>
                        </div>`
                     : ''
                   }
                 </div>
               </div>`
            : ''
          }
        `;
      }

      // === НАВИГАЦИЯ ===
      async function loadSports() {
        showLoading();
        try {
          state.sports = await getAllSports();
          renderSports(state.sports);
          showSection('sportsSection');
          updateBreadcrumb([{ label: 'Виды спорта' }]);
        } catch (error) {
          console.error('Ошибка загрузки видов спорта:', error);
          showError('Не удалось загрузить виды спорта. Попробуйте позже.');
        }
      }

      async function selectSport(sportName) {
        showLoading();
        state.currentSport = sportName;
        try {
          state.leagues = await getLeaguesBySport(sportName);
          renderLeagues(state.leagues);
          showSection('leaguesSection');
          updateBreadcrumb([
            { label: 'Виды спорта', onclick: 'loadSports()' },
            { label: sportName }
          ]);
        } catch (error) {
          console.error('Ошибка загрузки лиг:', error);
          showError('Не удалось загрузить лиги. Попробуйте позже.');
        }
      }

      async function selectLeague(leagueName) {
        showLoading();
        state.currentLeague = leagueName;
        try {
          state.teams = await getTeamsByLeague(leagueName);
          renderTeams(state.teams);
          showSection('teamsSection');
          updateBreadcrumb([
            { label: 'Виды спорта', onclick: 'loadSports()' },
            { label: state.currentSport, onclick: `selectSport('${state.currentSport}')` },
            { label: leagueName }
          ]);
        } catch (error) {
          console.error('Ошибка загрузки команд:', error);
          showError('Не удалось загрузить команды. Попробуйте позже.');
        }
      }

      async function selectTeam(teamId) {
        showLoading();
        state.currentTeam = teamId;
        try {
          const team = await getTeamById(teamId);
          renderTeamDetail(team);
          showSection('teamDetailSection');

          const breadcrumbItems = [
            { label: 'Виды спорта', onclick: 'loadSports()' }
          ];

          if (state.currentSport) {
            breadcrumbItems.push({
              label: state.currentSport,
              onclick: `selectSport('${state.currentSport}')`
            });
          }

          if (state.currentLeague) {
            breadcrumbItems.push({
              label: state.currentLeague,
              onclick: `selectLeague('${escapeHtml(state.currentLeague)}')`
            });
          }

          breadcrumbItems.push({ label: team ? team.strTeam : 'Команда' });

          updateBreadcrumb(breadcrumbItems);
        } catch (error) {
          console.error('Ошибка загрузки информации о команде:', error);
          showError('Не удалось загрузить информацию о команде. Попробуйте позже.');
        }
      }

      // === ПОИСК ===
      let searchTimeout = null;
      let currentSearchController = null;

      async function performSearch(query) {
        if (query.length < 2) {
          document.getElementById('autocompleteResults').classList.remove('active');
          return;
        }

        // Отменяем предыдущий запрос если он еще выполняется
        if (currentSearchController) {
          currentSearchController.abort();
        }
        currentSearchController = new AbortController();

        try {
          const teams = await searchTeams(query, currentSearchController.signal);
          const resultsContainer = document.getElementById('autocompleteResults');

          if (!teams || teams.length === 0) {
            resultsContainer.innerHTML = `
              <div class="autocomplete-item">
                <span>Ничего не найдено</span>
              </div>
            `;
          } else {
            resultsContainer.innerHTML = teams.slice(0, 10).map(team => `
              <div class="autocomplete-item" data-action="selectTeamFromSearch" data-team-id="${team.idTeam}" data-sport="${encodeURIComponent(team.strSport || '')}" data-league="${encodeURIComponent(team.strLeague || '')}" tabindex="0" role="button" aria-label="Выбрать команду ${team.strTeam}">
                ${team.strBadge
                  ? `<img src="${team.strBadge}" alt="Эмблема команды ${team.strTeam}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22/>'">`
                  : '<i class="fas fa-shield-halved"></i>'
                }
                <div>
                  <div style="font-weight:600;">${team.strTeam}</div>
                  <div style="font-size:0.85rem;color:var(--text-secondary);">${team.strLeague || ''}</div>
                </div>
              </div>
            `).join('');
          }

          resultsContainer.classList.add('active');
        } catch (error) {
          if (error.name === 'AbortError') {
            // Запрос был отменен, не выводим ошибку
            return;
          }
          console.error('Ошибка поиска:', error);
        } finally {
          currentSearchController = null;
        }
      }

      function selectTeamFromSearch(teamId, sport, league) {
        document.getElementById('autocompleteResults').classList.remove('active');
        document.getElementById('searchInput').value = '';
        
        if (isValidSport(sport)) {
          state.currentSport = sport;
        } else {
          state.currentSport = null;
          console.warn('Invalid sport value from search:', sport);
        }
        
        if (isValidLeague(league, sport)) {
          state.currentLeague = league;
        } else {
          state.currentLeague = null;
          console.warn('Invalid league value from search:', league);
        }
        
        selectTeam(teamId);
      }

      function escapeHtml(text) {
        if (!text) return '';
        return text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // Валидация состояния для безопасной навигации
      function isValidSport(sport) {
        return state.sports && state.sports.some(s => s.strSport === sport);
      }

      function isValidLeague(league, sport) {
        if (!state.leagues || !sport) return false;
        // Найти лиги для данного вида спорта
        const leaguesForSport = state.leagues.filter(l => l.strSport === sport);
        return leaguesForSport.some(l => l.strLeague === league);
      }

      // Функция для создания корректного URL социальной сети
      function createSocialUrl(url, platform) {
        if (!url) return '';
        
        // Убираем протокол если он уже есть
        const cleanUrl = url.replace(/^https?:\/\//, '').replace(/^www\./, '');
        
        // Добавляем протокол
        return `https://${cleanUrl}`;
      }

      // === СИСТЕМА НАСТРОЕК ===
      window.aiPagesSettings = {
        defaults: {
          theme: 'light'
        },

        get(key) {
          const value = localStorage.getItem(key);
          return value !== null ? value : this.defaults[key];
        },

        set(key, value) {
          localStorage.setItem(key, value);
          if (key === 'theme') {
            this.applyTheme();
          }
          this.notifyChange(key, value);
        },

        applyTheme() {
          const theme = this.get('theme');
          document.documentElement.setAttribute('data-theme', theme);
          const themeSwitch = document.getElementById('themeSwitch');
          if (themeSwitch) {
            themeSwitch.checked = theme === 'dark';
          }
        },

        migrate() {
          const oldTheme = localStorage.getItem('settings.darkTheme');
          if (oldTheme === 'true' && !localStorage.getItem('theme')) {
            localStorage.setItem('theme', 'dark');
            localStorage.removeItem('settings.darkTheme');
          }
        },

        init() {
          this.migrate();
          this.applyTheme();

          if (typeof BroadcastChannel !== 'undefined') {
            this.broadcastChannel = new BroadcastChannel('aiPagesSettings');
            this.broadcastChannel.onmessage = (event) => {
              const { type, key } = event.data;
              if (type === 'setting-changed' && key === 'theme') {
                this.applyTheme();
              }
            };
          }
        },

        notifyChange(key, value) {
          if (this.broadcastChannel) {
            this.broadcastChannel.postMessage({
              type: 'setting-changed',
              key: key,
              value: value
            });
          }
        }
      };

      // === СИСТЕМА СОБЫТИЙ ===
      function setupEventDelegation() {
        // Обработчик для всех кликов по элементам с data-action
        document.addEventListener('click', function(e) {
          const target = e.target.closest('[data-action]');
          if (!target) return;
          
          const action = target.getAttribute('data-action');
          handleAction(action, target, e);
        });

        // Обработчик клавиатуры для доступности
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            const target = e.target;
            if (target.hasAttribute('data-action')) {
              e.preventDefault();
              const action = target.getAttribute('data-action');
              handleAction(action, target, e);
            }
          }
        });

        // Обработчик для breadcrumb навигации
        document.getElementById('breadcrumb').addEventListener('click', function(e) {
          const target = e.target.closest('[data-action]');
          if (!target) return;
          
          const actionCode = decodeURIComponent(target.getAttribute('data-action'));
          try {
            eval(actionCode);
          } catch (error) {
            console.error('Ошибка выполнения действия breadcrumb:', error);
          }
        });

        // Обработчик клавиатуры для breadcrumb
        document.getElementById('breadcrumb').addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            const target = e.target;
            if (target.hasAttribute('data-action')) {
              e.preventDefault();
              const actionCode = decodeURIComponent(target.getAttribute('data-action'));
              try {
                eval(actionCode);
              } catch (error) {
                console.error('Ошибка выполнения действия breadcrumb:', error);
              }
            }
          }
        });
      }

      function handleAction(action, element, event) {
        switch (action) {
          case 'selectSport':
            const sport = decodeURIComponent(element.getAttribute('data-sport'));
            selectSport(sport);
            break;
            
          case 'selectLeague':
            const league = decodeURIComponent(element.getAttribute('data-league'));
            selectLeague(league);
            break;
            
          case 'selectTeam':
            const teamId = element.getAttribute('data-team-id');
            selectTeam(teamId);
            break;
            
          case 'selectTeamFromSearch':
            const searchTeamId = element.getAttribute('data-team-id');
            const searchSport = decodeURIComponent(element.getAttribute('data-sport') || '');
            const searchLeague = decodeURIComponent(element.getAttribute('data-league') || '');
            selectTeamFromSearch(searchTeamId, searchSport, searchLeague);
            break;
            
          default:
            console.warn('Неизвестное действие:', action);
        }
      }

      // === ИНИЦИАЛИЗАЦИЯ ===
      document.addEventListener('DOMContentLoaded', function() {
        // Инициализация настроек
        window.aiPagesSettings.init();
        
        // Инициализация системы событий
        setupEventDelegation();

        // Элементы
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const themeSwitch = document.getElementById('themeSwitch');
        const autocompleteResults = document.getElementById('autocompleteResults');

        // Поиск
        searchInput.addEventListener('input', function() {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            performSearch(this.value.trim());
          }, 300);
        });

        searchBtn.addEventListener('click', function() {
          const query = searchInput.value.trim();
          if (query) {
            performSearch(query);
          }
        });

        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query) {
              performSearch(query);
            }
          }
        });

        // Закрытие автодополнения при клике вне
        document.addEventListener('click', function(e) {
          if (!e.target.closest('.search-wrapper')) {
            autocompleteResults.classList.remove('active');
          }
        });

        // Навигация назад
        document.getElementById('backToSports').addEventListener('click', loadSports);
        document.getElementById('backToLeagues').addEventListener('click', function() {
          if (state.currentSport) {
            selectSport(state.currentSport);
          } else {
            loadSports();
          }
        });
        document.getElementById('backToTeams').addEventListener('click', function() {
          if (state.currentLeague) {
            selectLeague(state.currentLeague);
          } else if (state.currentSport) {
            selectSport(state.currentSport);
          } else {
            loadSports();
          }
        });

        // Настройки
        settingsButton.addEventListener('click', () => {
          settingsModal.style.display = 'block';
        });

        closeSettings.addEventListener('click', () => {
          settingsModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
          if (e.target === settingsModal) {
            settingsModal.style.display = 'none';
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && settingsModal.style.display === 'block') {
            settingsModal.style.display = 'none';
          }
        });

        themeSwitch.addEventListener('change', function() {
          const theme = this.checked ? 'dark' : 'light';
          window.aiPagesSettings.set('theme', theme);
        });

        // Загрузка видов спорта
        loadSports();
      });
    </script>
  </body>
</html>
