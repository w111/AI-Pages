<!doctype html>
<!--
ТЗ:
1. Создать интерактивный 3D-глобус Земли используя Three.js
2. Разместить маркеры на глобусе с привязкой к странам
3. Каждый маркер представляет радиостанцию с возможностью прослушивания
4. Реализовать интерфейс выбора радиостанций по странам
5. Воспроизведение радио через HTML5 Audio API
6. Интерактивное управление:
   - Вращение глобуса мышью
   - Зум колесиком мыши
   - Клик по маркеру для воспроизведения радио
   - Список радиостанций с поиском и фильтрацией
7. Визуализация:
   - Реалистичная текстура Земли
   - Анимированные маркеры радиостанций
   - Подсветка активной радиостанции
   - Атмосферное освещение
8. UI элементы:
   - Панель управления воспроизведением
   - Список радиостанций
   - Информация о текущей станции
   - Регулятор громкости
9. Темная и светлая тема
10. Многоязычность (русский/английский)
11. Адаптивный дизайн
-->
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D Radio Globe - Радиостанции мира</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-color: #0a0e27;
      --text-color: #ffffff;
      --panel-bg: rgba(10, 14, 39, 0.9);
      --panel-border: rgba(255, 255, 255, 0.1);
      --accent-color: #00d4ff;
      --accent-hover: #00a8cc;
      --marker-color: #ff6b6b;
      --marker-active: #51cf66;
    }

    body.light-theme {
      --bg-color: #f0f4f8;
      --text-color: #1a1a1a;
      --panel-bg: rgba(255, 255, 255, 0.95);
      --panel-border: rgba(0, 0, 0, 0.1);
      --accent-color: #0066cc;
      --accent-hover: #0052a3;
      --marker-color: #e03131;
      --marker-active: #2b8a3e;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      overflow: hidden;
      background: var(--bg-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-color);
      transition: background 0.3s ease;
    }

    #canvas-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    /* Верхняя панель */
    #top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--panel-bg);
      border-bottom: 1px solid var(--panel-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 20px;
      font-weight: bold;
    }

    .logo i {
      color: var(--accent-color);
    }

    .top-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .icon-btn {
      background: none;
      border: 1px solid var(--panel-border);
      color: var(--text-color);
      width: 40px;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .icon-btn:hover {
      background: var(--accent-color);
      border-color: var(--accent-color);
      transform: scale(1.05);
    }

    /* Боковая панель со станциями */
    #stations-panel {
      position: absolute;
      top: 60px;
      right: 0;
      width: 350px;
      height: calc(100vh - 60px);
      background: var(--panel-bg);
      border-left: 1px solid var(--panel-border);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 999;
      backdrop-filter: blur(10px);
      overflow-y: auto;
    }

    #stations-panel.open {
      transform: translateX(0);
    }

    .panel-header {
      padding: 20px;
      border-bottom: 1px solid var(--panel-border);
    }

    .panel-header h2 {
      margin-bottom: 15px;
      font-size: 18px;
    }

    #search-input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--panel-border);
      border-radius: 8px;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: 14px;
    }

    #search-input::placeholder {
      color: var(--text-color);
      opacity: 0.5;
    }

    #country-filter {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid var(--panel-border);
      border-radius: 8px;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: 14px;
    }

    #stations-list {
      padding: 10px;
    }

    .station-item {
      padding: 15px;
      margin-bottom: 10px;
      background: var(--bg-color);
      border: 1px solid var(--panel-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .station-item:hover {
      border-color: var(--accent-color);
      transform: translateX(-5px);
    }

    .station-item.active {
      border-color: var(--marker-active);
      background: rgba(81, 207, 102, 0.1);
    }

    .station-name {
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--text-color);
    }

    .station-country {
      font-size: 12px;
      opacity: 0.7;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Панель плеера */
    #player-panel {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      min-width: 400px;
      max-width: 90vw;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      padding: 20px;
      z-index: 999;
      backdrop-filter: blur(10px);
      display: none;
    }

    #player-panel.show {
      display: block;
    }

    .player-info {
      margin-bottom: 15px;
    }

    .player-station-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .player-country {
      font-size: 14px;
      opacity: 0.7;
    }

    .player-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .play-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--accent-color);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s ease;
    }

    .play-btn:hover {
      background: var(--accent-hover);
      transform: scale(1.05);
    }

    .volume-control {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .volume-slider {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: var(--panel-border);
      -webkit-appearance: none;
      appearance: none;
      outline: none;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent-color);
      cursor: pointer;
    }

    .volume-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent-color);
      cursor: pointer;
      border: none;
    }

    /* Информационная панель */
    #info-panel {
      position: absolute;
      top: 80px;
      left: 20px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      padding: 15px;
      max-width: 300px;
      z-index: 998;
      backdrop-filter: blur(10px);
    }

    #info-panel h3 {
      font-size: 16px;
      margin-bottom: 10px;
      color: var(--accent-color);
    }

    #info-panel p {
      font-size: 14px;
      line-height: 1.6;
      opacity: 0.9;
    }

    /* Loading */
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 1001;
    }

    .spinner {
      border: 4px solid var(--panel-border);
      border-top: 4px solid var(--accent-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .3s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--accent-color);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    /* Responsive */
    @media (max-width: 768px) {
      #stations-panel {
        width: 100%;
      }

      #info-panel {
        display: none;
      }

      #player-panel {
        min-width: auto;
        width: calc(100% - 40px);
      }
    }
  </style>
</head>
<body>
  <!-- Loading -->
  <div id="loading">
    <div class="spinner"></div>
    <p id="loading-text">Загрузка глобуса...</p>
  </div>

  <!-- Верхняя панель -->
  <div id="top-bar">
    <div class="logo">
      <i class="fas fa-globe-americas"></i>
      <span id="app-title">Radio Globe</span>
    </div>
    <div class="top-controls">
      <button class="icon-btn" id="list-btn" title="Список станций">
        <i class="fas fa-list"></i>
      </button>
      <label class="toggle-switch">
        <input type="checkbox" id="theme-toggle">
        <span class="slider"></span>
      </label>
      <button class="icon-btn" id="lang-btn" title="Language">
        <i class="fas fa-language"></i>
      </button>
    </div>
  </div>

  <!-- Информационная панель -->
  <div id="info-panel">
    <h3 id="info-title">Как использовать</h3>
    <p id="info-text">
      • Вращайте глобус мышью<br>
      • Увеличивайте колесиком<br>
      • Кликайте на маркеры для прослушивания радио<br>
      • Используйте панель справа для поиска станций
    </p>
  </div>

  <!-- Панель со станциями -->
  <div id="stations-panel">
    <div class="panel-header">
      <h2 id="stations-title">Радиостанции</h2>
      <input type="text" id="search-input" placeholder="Поиск станций...">
      <select id="country-filter">
        <option value="">Все страны</option>
      </select>
    </div>
    <div id="stations-list"></div>
  </div>

  <!-- Панель плеера -->
  <div id="player-panel">
    <div class="player-info">
      <div class="player-station-name" id="player-station-name">--</div>
      <div class="player-country" id="player-country">--</div>
    </div>
    <div class="player-controls">
      <button class="play-btn" id="play-btn">
        <i class="fas fa-play"></i>
      </button>
      <div class="volume-control">
        <i class="fas fa-volume-down"></i>
        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70">
        <i class="fas fa-volume-up"></i>
      </div>
    </div>
  </div>

  <div id="canvas-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
  <script>
    // ============== Конфигурация ==============
    const CONFIG = {
      globe: {
        radius: 2,
        segments: 64
      },
      camera: {
        fov: 45,
        near: 0.1,
        far: 1000,
        position: [0, 0, 6]
      },
      marker: {
        size: 0.03,
        height: 0.1,
        activeScale: 1.5,
        pulseSpeed: 2
      }
    };

    // ============== Мультиязычность ==============
    const i18n = {
      ru: {
        appTitle: "Radio Globe",
        loadingText: "Загрузка глобуса...",
        stationsTitle: "Радиостанции",
        searchPlaceholder: "Поиск станций...",
        allCountries: "Все страны",
        infoTitle: "Как использовать",
        infoText: "• Вращайте глобус мышью<br>• Увеличивайте колесиком<br>• Кликайте на маркеры для прослушивания радио<br>• Используйте панель справа для поиска станций",
        noStations: "Станции не найдены",
        loading: "Загрузка..."
      },
      en: {
        appTitle: "Radio Globe",
        loadingText: "Loading globe...",
        stationsTitle: "Radio Stations",
        searchPlaceholder: "Search stations...",
        allCountries: "All countries",
        infoTitle: "How to use",
        infoText: "• Rotate globe with mouse<br>• Zoom with mouse wheel<br>• Click markers to listen to radio<br>• Use right panel to search stations",
        noStations: "No stations found",
        loading: "Loading..."
      }
    };

    let currentLang = "ru";

    function t(key) {
      return i18n[currentLang][key] || key;
    }

    function updateLanguage() {
      document.getElementById("app-title").textContent = t("appTitle");
      document.getElementById("loading-text").textContent = t("loadingText");
      document.getElementById("stations-title").textContent = t("stationsTitle");
      document.getElementById("search-input").placeholder = t("searchPlaceholder");
      document.getElementById("info-title").textContent = t("infoTitle");
      document.getElementById("info-text").innerHTML = t("infoText");

      const countryFilter = document.getElementById("country-filter");
      const firstOption = countryFilter.querySelector("option");
      if (firstOption) {
        firstOption.textContent = t("allCountries");
      }
    }

    // ============== Радиостанции ==============
    // Проверенные рабочие радиостанции по странам (60+ станций из 25+ стран)
    const radioStations = [
      // Россия
      { name: "Радио Рекорд", country: "Russia", countryCode: "RU", lat: 55.7558, lon: 37.6173, url: "https://radiorecord.hostingradio.ru/rr_main96.aacp" },
      { name: "Европа Плюс", country: "Russia", countryCode: "RU", lat: 55.7558, lon: 37.6173, url: "https://ep256.hostingradio.ru:8052/europaplus256.mp3" },
      { name: "Хит FM", country: "Russia", countryCode: "RU", lat: 55.7558, lon: 37.6173, url: "https://hitfm.hostingradio.ru/hitfm96.aacp" },
      { name: "Русское Радио", country: "Russia", countryCode: "RU", lat: 55.7558, lon: 37.6173, url: "https://rusradio.hostingradio.ru/rusradio96.aacp" },

      // США
      { name: "KEXP 90.3 FM", country: "USA", countryCode: "US", lat: 47.6062, lon: -122.3321, url: "https://kexp-mp3-128.streamguys1.com/kexp128.mp3" },
      { name: "NPR News", country: "USA", countryCode: "US", lat: 40.7128, lon: -74.0060, url: "https://npr-ice.streamguys1.com/live.mp3" },
      { name: "Jazz24", country: "USA", countryCode: "US", lat: 47.6062, lon: -122.3321, url: "https://live.amperwave.net/direct/ppm-jazz24aac-ibc1" },
      { name: "WNYC FM", country: "USA", countryCode: "US", lat: 40.7128, lon: -74.0060, url: "https://fm939.wnyc.org/wnycfm" },

      // Великобритания
      { name: "Absolute Radio", country: "UK", countryCode: "GB", lat: 51.5074, lon: -0.1278, url: "https://icecast.thisisdax.com/AbsoluteRadioHigh.aac" },
      { name: "Capital FM", country: "UK", countryCode: "GB", lat: 51.5074, lon: -0.1278, url: "https://media-ssl.musicradio.com/CapitalMP3" },
      { name: "Heart FM", country: "UK", countryCode: "GB", lat: 51.5074, lon: -0.1278, url: "https://media-ssl.musicradio.com/HeartLondonMP3" },
      { name: "Classic FM", country: "UK", countryCode: "GB", lat: 51.5074, lon: -0.1278, url: "https://media-ssl.musicradio.com/ClassicFMMP3" },

      // Франция
      { name: "Radio Nova", country: "France", countryCode: "FR", lat: 48.8566, lon: 2.3522, url: "https://novazz.ice.infomaniak.ch/novazz-128.mp3" },
      { name: "NRJ France", country: "France", countryCode: "FR", lat: 48.8566, lon: 2.3522, url: "https://scdn.nrjaudio.fm/fr/30001/mp3_128.mp3" },
      { name: "RTL", country: "France", countryCode: "FR", lat: 48.8566, lon: 2.3522, url: "https://streaming.radio.rtl.fr/rtl-1-44-128" },
      { name: "Skyrock", country: "France", countryCode: "FR", lat: 48.8566, lon: 2.3522, url: "https://icecast.skyrock.net/s/natio_mp3_128k" },

      // Германия
      { name: "1LIVE", country: "Germany", countryCode: "DE", lat: 52.5200, lon: 13.4050, url: "https://wdr-1live-live.icecastssl.wdr.de/wdr/1live/live/mp3/128/stream.mp3" },
      { name: "Antenne Bayern", country: "Germany", countryCode: "DE", lat: 48.1351, lon: 11.5820, url: "https://stream.antenne.de/antenne" },
      { name: "Bayern 3", country: "Germany", countryCode: "DE", lat: 48.1351, lon: 11.5820, url: "https://dispatcher.rndfnk.com/br/br3/live/mp3/low" },
      { name: "Deutschlandfunk", country: "Germany", countryCode: "DE", lat: 52.5200, lon: 13.4050, url: "https://st01.sslstream.dlf.de/dlf/01/128/mp3/stream.mp3" },

      // Италия
      { name: "Radio 105", country: "Italy", countryCode: "IT", lat: 45.4642, lon: 9.1900, url: "https://icy.unitedradio.it/Radio105.mp3" },
      { name: "RDS Radio", country: "Italy", countryCode: "IT", lat: 45.4642, lon: 9.1900, url: "https://stream.rds.radio/audio/rds.stream_aac/playlist.m3u8" },
      { name: "Radio Capital", country: "Italy", countryCode: "IT", lat: 45.4642, lon: 9.1900, url: "https://icy.unitedradio.it/Capital.mp3" },
      { name: "Radio DeeJay", country: "Italy", countryCode: "IT", lat: 45.4642, lon: 9.1900, url: "https://radiodeejay-lh.akamaihd.net/i/RadioDeejay_Live_1@189857/index_96_a-p.m3u8" },

      // Испания
      { name: "Los 40", country: "Spain", countryCode: "ES", lat: 40.4168, lon: -3.7038, url: "https://playerservices.streamtheworld.com/api/livestream-redirect/LOS40.mp3" },
      { name: "Cadena 100", country: "Spain", countryCode: "ES", lat: 40.4168, lon: -3.7038, url: "https://cadena100-cope-rrcast.flumotion.com/cope/cadena100.mp3" },
      { name: "Europa FM", country: "Spain", countryCode: "ES", lat: 40.4168, lon: -3.7038, url: "https://europafm-live.flumotion.com/playlist.m3u8" },

      // Бразилия
      { name: "Rádio Jovem Pan", country: "Brazil", countryCode: "BR", lat: -23.5505, lon: -46.6333, url: "https://playerservices.streamtheworld.com/api/livestream-redirect/JOVEMPAN_SP.aac" },
      { name: "Rádio Mix", country: "Brazil", countryCode: "BR", lat: -23.5505, lon: -46.6333, url: "https://playerservices.streamtheworld.com/api/livestream-redirect/RADIOMIX.aac" },
      { name: "Rádio 89 FM", country: "Brazil", countryCode: "BR", lat: -23.5505, lon: -46.6333, url: "https://playerservices.streamtheworld.com/api/livestream-redirect/RADIO89FMAAC.aac" },

      // Австралия
      { name: "Triple J", country: "Australia", countryCode: "AU", lat: -33.8688, lon: 151.2093, url: "https://live-radio01.mediahubaustralia.com/2TJW/mp3/" },
      { name: "Nova 96.9", country: "Australia", countryCode: "AU", lat: -33.8688, lon: 151.2093, url: "https://icy.nova.net.au/stream/novafm969" },
      { name: "KIIS 106.5", country: "Australia", countryCode: "AU", lat: -33.8688, lon: 151.2093, url: "https://live.wostreaming.net/direct/arxmedia-kiisfmaac-ibc1" },

      // Канада
      { name: "CBC Radio One", country: "Canada", countryCode: "CA", lat: 45.4215, lon: -75.6972, url: "https://playerservices.streamtheworld.com/api/livestream-redirect/CBC_R1_OTT_H.aac" },
      { name: "Virgin Radio Toronto", country: "Canada", countryCode: "CA", lat: 43.6532, lon: -79.3832, url: "https://live.leanstream.co/CISSAFM" },
      { name: "CHUM 104.5", country: "Canada", countryCode: "CA", lat: 43.6532, lon: -79.3832, url: "https://live.leanstream.co/CHUMFM" },

      // Нидерланды
      { name: "Radio 538", country: "Netherlands", countryCode: "NL", lat: 52.3676, lon: 4.9041, url: "https://21223.live.streamtheworld.com/RADIO538.mp3" },
      { name: "Slam FM", country: "Netherlands", countryCode: "NL", lat: 52.3676, lon: 4.9041, url: "https://stream.slam.nl/slam_mp3" },
      { name: "Q-Music", country: "Netherlands", countryCode: "NL", lat: 52.3676, lon: 4.9041, url: "https://icecast-qmusicnl-cdp.triple-it.nl/Qmusic_nl_live.mp3" },

      // Швеция
      { name: "Sveriges Radio P3", country: "Sweden", countryCode: "SE", lat: 59.3293, lon: 18.0686, url: "https://http-live.sr.se/p3-mp3-192" },
      { name: "Mix Megapol", country: "Sweden", countryCode: "SE", lat: 59.3293, lon: 18.0686, url: "https://live-bauerse-fm.sharp-stream.com/mixmegapol_instream_se_aacp" },
      { name: "Rix FM", country: "Sweden", countryCode: "SE", lat: 59.3293, lon: 18.0686, url: "https://live-bauerse-fm.sharp-stream.com/rixfm_se_aacp" },

      // Польша
      { name: "RMF FM", country: "Poland", countryCode: "PL", lat: 52.2297, lon: 21.0122, url: "https://rs9-krk2.rmfstream.pl/rmf_fm" },
      { name: "Radio ZET", country: "Poland", countryCode: "PL", lat: 52.2297, lon: 21.0122, url: "https://n-22-12.dcs.redcdn.pl/sc/o2/Eurozet/live/audio.livx" },
      { name: "Radio Eska", country: "Poland", countryCode: "PL", lat: 52.2297, lon: 21.0122, url: "https://radio.stream.smcdn.pl/icradio/2380-1.aac" },

      // Япония
      { name: "FMJ Wave 80.7", country: "Japan", countryCode: "JP", lat: 35.6762, lon: 139.6503, url: "https://stream.zeno.fm/f3wvbbqmdg8uv" },
      { name: "J1 Radio", country: "Japan", countryCode: "JP", lat: 35.6762, lon: 139.6503, url: "https://stream.zeno.fm/0r0xa792kwzuv" },

      // Норвегия
      { name: "NRJ Norway", country: "Norway", countryCode: "NO", lat: 59.9139, lon: 10.7522, url: "https://nrj.p4groupaudio.com/NRJ_NO_MP3" },
      { name: "Radio Norge", country: "Norway", countryCode: "NO", lat: 59.9139, lon: 10.7522, url: "https://live-bauerse-fm.sharp-stream.com/radionorge_no_aacp" },

      // Дания
      { name: "Radio24syv", country: "Denmark", countryCode: "DK", lat: 55.6761, lon: 12.5683, url: "https://live-bauerse-fm.sharp-stream.com/nova_dk_aacp" },
      { name: "Sky Radio", country: "Denmark", countryCode: "DK", lat: 55.6761, lon: 12.5683, url: "https://live-bauerse-fm.sharp-stream.com/skyradio_dk_aacp" },

      // Финляндия
      { name: "Radio Nova Finland", country: "Finland", countryCode: "FI", lat: 60.1699, lon: 24.9384, url: "https://live-bauerse-fm.sharp-stream.com/radionova_fi_aacp" },
      { name: "Radio Suomipop", country: "Finland", countryCode: "FI", lat: 60.1699, lon: 24.9384, url: "https://live-bauerse-fm.sharp-stream.com/radiosuomipop_fi_aacp" },

      // Бельгия
      { name: "Studio Brussel", country: "Belgium", countryCode: "BE", lat: 50.8503, lon: 4.3517, url: "https://icecast.vrtcdn.be/stubru-high.mp3" },
      { name: "Joe FM", country: "Belgium", countryCode: "BE", lat: 50.8503, lon: 4.3517, url: "https://icecast.cdn.dpgmedia.net/joe_fm_hi.aac" },

      // Швейцария
      { name: "Radio Swiss Pop", country: "Switzerland", countryCode: "CH", lat: 46.9480, lon: 7.4474, url: "https://stream.srg-ssr.ch/m/rsp/mp3_128" },
      { name: "Radio Swiss Jazz", country: "Switzerland", countryCode: "CH", lat: 46.9480, lon: 7.4474, url: "https://stream.srg-ssr.ch/m/rsj/mp3_128" },

      // Австрия
      { name: "Ö3 Austria", country: "Austria", countryCode: "AT", lat: 48.2082, lon: 16.3738, url: "https://orf-live.ors-shoutcast.at/oe3-q2a" },
      { name: "Kronehit", country: "Austria", countryCode: "AT", lat: 48.2082, lon: 16.3738, url: "https://secureonair.krone.at/kronehit.mp3" },

      // Португалия
      { name: "Radio Comercial", country: "Portugal", countryCode: "PT", lat: 38.7223, lon: -9.1393, url: "https://stream-icy.bauermedia.pt/comercial.mp3" },
      { name: "M80 Radio", country: "Portugal", countryCode: "PT", lat: 38.7223, lon: -9.1393, url: "https://mcrscast.mcr.iol.pt/m80" },

      // Южная Корея
      { name: "KBS Cool FM", country: "South Korea", countryCode: "KR", lat: 37.5665, lon: 126.9780, url: "https://stream.zeno.fm/h9rq9sgqs5zuv" },

      // Новая Зеландия
      { name: "ZM Auckland", country: "New Zealand", countryCode: "NZ", lat: -36.8485, lon: 174.7633, url: "https://ais-nzme.streamguys1.com/nz_011_aac" },

      // Ирландия
      { name: "Today FM", country: "Ireland", countryCode: "IE", lat: 53.3498, lon: -6.2603, url: "https://icy.stream.co.uk/todayfm" },
      { name: "98FM Dublin", country: "Ireland", countryCode: "IE", lat: 53.3498, lon: -6.2603, url: "https://icy.stream.co.uk/98fm" }
    ];

    // ============== Инициализация Three.js ==============
    let scene, camera, renderer, globe, markers = [], controls;
    let isRotating = true;
    let currentStation = null;
    let audioElement = null;

    function init() {
      // Сцена
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0a0e27);

      // Камера
      camera = new THREE.PerspectiveCamera(
        CONFIG.camera.fov,
        window.innerWidth / window.innerHeight,
        CONFIG.camera.near,
        CONFIG.camera.far
      );
      camera.position.set(...CONFIG.camera.position);

      // Рендерер
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      document.getElementById("canvas-container").appendChild(renderer.domElement);

      // Освещение
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(5, 3, 5);
      scene.add(directionalLight);

      const pointLight = new THREE.PointLight(0x00d4ff, 0.5, 100);
      pointLight.position.set(-5, 5, 5);
      scene.add(pointLight);

      // Создание глобуса
      createGlobe();

      // Создание маркеров
      createMarkers();

      // Настройка управления
      setupControls();

      // Обработчики событий
      setupEventListeners();

      // Инициализация UI
      initUI();

      // Скрыть загрузку
      setTimeout(() => {
        document.getElementById("loading").style.display = "none";
      }, 1000);

      // Запуск анимации
      animate();
    }

    function createGlobe() {
      // Загрузка реалистичной текстуры Земли
      const textureLoader = new THREE.TextureLoader();

      // Используем высококачественную текстуру Земли
      const earthTexture = textureLoader.load(
        'https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg',
        () => {
          // Колбэк после загрузки текстуры
          console.log('Текстура Земли загружена');
        },
        undefined,
        (error) => {
          // Резервный вариант - создаем простую текстуру
          console.warn('Не удалось загрузить текстуру, используется резервная');
          createFallbackTexture();
        }
      );

      const geometry = new THREE.SphereGeometry(
        CONFIG.globe.radius,
        CONFIG.globe.segments,
        CONFIG.globe.segments
      );

      const material = new THREE.MeshPhongMaterial({
        map: earthTexture,
        shininess: 5,
        specular: new THREE.Color(0x222222),
        bumpScale: 0.05
      });

      globe = new THREE.Mesh(geometry, material);
      scene.add(globe);

      // Атмосфера
      const atmosphereGeometry = new THREE.SphereGeometry(
        CONFIG.globe.radius * 1.01,
        CONFIG.globe.segments,
        CONFIG.globe.segments
      );
      const atmosphereMaterial = new THREE.MeshPhongMaterial({
        color: 0x4a90e2,
        transparent: true,
        opacity: 0.15,
        side: THREE.BackSide
      });
      const atmosphere = new THREE.Mesh(atmosphereGeometry, atmosphereMaterial);
      globe.add(atmosphere); // Добавляем атмосферу к глобусу

      function createFallbackTexture() {
        // Резервная текстура при ошибке загрузки
        const canvas = document.createElement("canvas");
        canvas.width = 2048;
        canvas.height = 1024;
        const ctx = canvas.getContext("2d");

        // Океаны
        const oceanGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        oceanGradient.addColorStop(0, "#1a4d7a");
        oceanGradient.addColorStop(0.5, "#2563a8");
        oceanGradient.addColorStop(1, "#1a4d7a");
        ctx.fillStyle = oceanGradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Континенты
        ctx.fillStyle = "#2d5a3f";

        // Более детальные континенты
        // Северная Америка
        ctx.beginPath();
        ctx.ellipse(300, 400, 120, 350, -0.3, 0, Math.PI * 2);
        ctx.fill();

        // Южная Америка
        ctx.beginPath();
        ctx.ellipse(450, 700, 90, 250, 0.2, 0, Math.PI * 2);
        ctx.fill();

        // Европа
        ctx.beginPath();
        ctx.ellipse(1000, 300, 100, 150, 0, 0, Math.PI * 2);
        ctx.fill();

        // Африка
        ctx.beginPath();
        ctx.ellipse(1050, 550, 120, 280, 0, 0, Math.PI * 2);
        ctx.fill();

        // Азия
        ctx.beginPath();
        ctx.ellipse(1400, 350, 280, 300, 0, 0, Math.PI * 2);
        ctx.fill();

        // Австралия
        ctx.beginPath();
        ctx.ellipse(1600, 750, 110, 90, 0, 0, Math.PI * 2);
        ctx.fill();

        const fallbackTexture = new THREE.CanvasTexture(canvas);
        globe.material.map = fallbackTexture;
        globe.material.needsUpdate = true;
      }
    }

    function latLonToVector3(lat, lon, radius) {
      const phi = (90 - lat) * (Math.PI / 180);
      const theta = (lon + 180) * (Math.PI / 180);

      const x = -(radius * Math.sin(phi) * Math.cos(theta));
      const z = radius * Math.sin(phi) * Math.sin(theta);
      const y = radius * Math.cos(phi);

      return new THREE.Vector3(x, y, z);
    }

    // Функция для получения эмоджи флага по коду страны
    function getFlagEmoji(countryCode) {
      const codePoints = countryCode
        .toUpperCase()
        .split('')
        .map(char => 127397 + char.charCodeAt(0));
      return String.fromCodePoint(...codePoints);
    }

    // Функция для создания текстуры флага
    function createFlagTexture(countryCode) {
      const canvas = document.createElement('canvas');
      canvas.width = 128;
      canvas.height = 128;
      const ctx = canvas.getContext('2d');

      // Фон
      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Рисуем флаг (эмоджи)
      ctx.font = '90px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(getFlagEmoji(countryCode), canvas.width / 2, canvas.height / 2);

      const texture = new THREE.CanvasTexture(canvas);
      texture.needsUpdate = true;
      return texture;
    }

    function createMarkers() {
      radioStations.forEach((station, index) => {
        // Создаем флаг страны
        const flagTexture = createFlagTexture(station.countryCode);

        // Спрайт с флагом
        const spriteMaterial = new THREE.SpriteMaterial({
          map: flagTexture,
          transparent: true,
          opacity: 1,
          sizeAttenuation: false
        });
        const flagSprite = new THREE.Sprite(spriteMaterial);
        flagSprite.scale.set(0.035, 0.035, 1); // Размер флага (уменьшен)

        // Позиционирование маркера
        const position = latLonToVector3(station.lat, station.lon, CONFIG.globe.radius);
        const direction = position.clone().normalize();

        // Поднимаем флаг над поверхностью глобуса
        const flagHeight = 0.1;
        flagSprite.position.copy(position.clone().add(direction.multiplyScalar(flagHeight)));

        // Флагшток (тонкая линия)
        const poleGeometry = new THREE.CylinderGeometry(0.003, 0.003, flagHeight, 8);
        const poleMaterial = new THREE.MeshPhongMaterial({
          color: 0x888888,
          emissive: 0x444444,
          emissiveIntensity: 0.3
        });
        const pole = new THREE.Mesh(poleGeometry, poleMaterial);

        // Позиционируем флагшток
        const polePosition = position.clone().add(direction.multiplyScalar(flagHeight / 2));
        pole.position.copy(polePosition);
        pole.lookAt(new THREE.Vector3(0, 0, 0));
        pole.rotateX(Math.PI / 2);

        // Светящийся круг в основании (уменьшен)
        const baseGeometry = new THREE.CircleGeometry(0.02, 16);
        const baseMaterial = new THREE.MeshBasicMaterial({
          color: 0x00d4ff,
          transparent: true,
          opacity: 0.6,
          side: THREE.DoubleSide
        });
        const base = new THREE.Mesh(baseGeometry, baseMaterial);
        base.position.copy(position);
        base.lookAt(camera.position);

        // Группа для маркера
        const markerGroup = new THREE.Group();
        markerGroup.add(pole);
        markerGroup.add(flagSprite);
        markerGroup.add(base);
        markerGroup.userData = { station, index, flagSprite, pole, base, baseScale: 1 };

        globe.add(markerGroup); // Добавляем маркеры к глобусу
        markers.push(markerGroup);
      });
    }

    function setupControls() {
      let isDragging = false;
      let previousMousePosition = { x: 0, y: 0 };
      let rotationVelocity = { x: 0, y: 0 };

      renderer.domElement.addEventListener("mousedown", (e) => {
        isDragging = true;
        isRotating = false;
        previousMousePosition = { x: e.clientX, y: e.clientY };
      });

      renderer.domElement.addEventListener("mousemove", (e) => {
        if (isDragging) {
          const deltaX = e.clientX - previousMousePosition.x;
          const deltaY = e.clientY - previousMousePosition.y;

          rotationVelocity.x = deltaY * 0.005;
          rotationVelocity.y = deltaX * 0.005;

          globe.rotation.y += rotationVelocity.y;
          globe.rotation.x += rotationVelocity.x;

          previousMousePosition = { x: e.clientX, y: e.clientY };
        }
      });

      renderer.domElement.addEventListener("mouseup", () => {
        isDragging = false;
      });

      renderer.domElement.addEventListener("wheel", (e) => {
        e.preventDefault();
        const delta = e.deltaY * 0.001;
        camera.position.z = Math.max(3, Math.min(10, camera.position.z + delta));
      });

      // Клик по маркеру
      renderer.domElement.addEventListener("click", (e) => {
        if (isDragging) return;

        const mouse = new THREE.Vector2();
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);

        const intersects = raycaster.intersectObjects(
          markers.flatMap(m => m.children),
          true
        );

        if (intersects.length > 0) {
          const clickedMarker = markers.find(m =>
            m.children.includes(intersects[0].object)
          );
          if (clickedMarker) {
            playStation(clickedMarker.userData.station);
          }
        }
      });
    }

    function setupEventListeners() {
      // Ресайз
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      // Переключатель темы
      document.getElementById("theme-toggle").addEventListener("change", (e) => {
        document.body.classList.toggle("light-theme", e.target.checked);
        scene.background = new THREE.Color(e.target.checked ? 0xf0f4f8 : 0x0a0e27);
      });

      // Переключатель языка
      document.getElementById("lang-btn").addEventListener("click", () => {
        currentLang = currentLang === "ru" ? "en" : "ru";
        updateLanguage();
      });

      // Кнопка списка станций
      document.getElementById("list-btn").addEventListener("click", () => {
        document.getElementById("stations-panel").classList.toggle("open");
      });

      // Поиск станций
      document.getElementById("search-input").addEventListener("input", (e) => {
        filterStations(e.target.value, document.getElementById("country-filter").value);
      });

      // Фильтр по стране
      document.getElementById("country-filter").addEventListener("change", (e) => {
        filterStations(document.getElementById("search-input").value, e.target.value);
      });

      // Управление плеером
      document.getElementById("play-btn").addEventListener("click", togglePlay);
      document.getElementById("volume-slider").addEventListener("input", (e) => {
        if (audioElement) {
          audioElement.volume = e.target.value / 100;
        }
      });
    }

    function initUI() {
      // Заполнение списка станций
      renderStationsList(radioStations);

      // Заполнение фильтра стран
      const countries = [...new Set(radioStations.map(s => s.country))].sort();
      const countryFilter = document.getElementById("country-filter");
      countries.forEach(country => {
        const option = document.createElement("option");
        option.value = country;
        option.textContent = country;
        countryFilter.appendChild(option);
      });
    }

    function renderStationsList(stations) {
      const listContainer = document.getElementById("stations-list");
      listContainer.innerHTML = "";

      if (stations.length === 0) {
        listContainer.innerHTML = `<p style="padding: 20px; text-align: center; opacity: 0.7;">${t("noStations")}</p>`;
        return;
      }

      stations.forEach(station => {
        const item = document.createElement("div");
        item.className = "station-item";
        item.innerHTML = `
          <div class="station-name">${station.name}</div>
          <div class="station-country">
            <i class="fas fa-map-marker-alt"></i>
            ${station.country}
          </div>
        `;
        item.addEventListener("click", () => playStation(station));
        listContainer.appendChild(item);
      });
    }

    function filterStations(searchTerm, country) {
      const filtered = radioStations.filter(station => {
        const matchesSearch = station.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            station.country.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesCountry = !country || station.country === country;
        return matchesSearch && matchesCountry;
      });
      renderStationsList(filtered);
    }

    function playStation(station) {
      currentStation = station;

      // Обновление UI плеера
      document.getElementById("player-station-name").textContent = station.name;
      document.getElementById("player-country").textContent = station.country;
      document.getElementById("player-panel").classList.add("show");

      // Создание/обновление аудио элемента
      if (audioElement) {
        audioElement.pause();
        audioElement.src = "";
      }

      audioElement = new Audio(station.url);
      audioElement.volume = document.getElementById("volume-slider").value / 100;
      audioElement.crossOrigin = "anonymous";

      // Попытка воспроизведения
      audioElement.play().catch(error => {
        console.error("Ошибка воспроизведения:", error);
        alert("Не удалось воспроизвести эту станцию. Попробуйте другую.");
      });

      // Обновление иконки плеера
      document.getElementById("play-btn").innerHTML = '<i class="fas fa-pause"></i>';

      // Подсветка активного маркера
      markers.forEach(marker => {
        const isActive = marker.userData.station === station;

        // Обновляем цвет основания и флагштока
        if (marker.userData.base) {
          marker.userData.base.material.color.setHex(isActive ? 0x51cf66 : 0x00d4ff);
          marker.userData.base.material.opacity = isActive ? 0.9 : 0.6;
        }

        if (marker.userData.pole) {
          marker.userData.pole.material.color.setHex(isActive ? 0xffd700 : 0x888888);
          marker.userData.pole.material.emissive.setHex(isActive ? 0xffa500 : 0x444444);
        }

        // Увеличиваем флаг активной станции
        if (marker.userData.flagSprite) {
          const scale = isActive ? 0.055 : 0.035;
          marker.userData.flagSprite.scale.set(scale, scale, 1);
        }
      });

      // Обновление активного элемента в списке
      document.querySelectorAll(".station-item").forEach(item => {
        item.classList.remove("active");
        if (item.querySelector(".station-name").textContent === station.name) {
          item.classList.add("active");
        }
      });
    }

    function togglePlay() {
      if (!audioElement) return;

      if (audioElement.paused) {
        audioElement.play();
        document.getElementById("play-btn").innerHTML = '<i class="fas fa-pause"></i>';
      } else {
        audioElement.pause();
        document.getElementById("play-btn").innerHTML = '<i class="fas fa-play"></i>';
      }
    }

    function animate() {
      requestAnimationFrame(animate);

      // Автоматическое вращение глобуса
      if (isRotating) {
        globe.rotation.y += 0.001;
      }

      // Анимация маркеров (легкое покачивание флагов)
      const time = Date.now() * 0.001;
      markers.forEach((marker, index) => {
        // Плавное покачивание флагов
        if (marker.userData.flagSprite) {
          const sway = Math.sin(time * 2 + index * 0.3) * 0.02;
          marker.userData.flagSprite.material.rotation = sway;
        }

        // Пульсация основания
        if (marker.userData.base) {
          const pulse = 1 + Math.sin(time * CONFIG.marker.pulseSpeed + index * 0.5) * 0.15;
          marker.userData.base.scale.set(pulse, pulse, 1);
        }
      });

      renderer.render(scene, camera);
    }

    // Запуск приложения
    window.addEventListener("DOMContentLoaded", () => {
      updateLanguage();
      init();
    });
  </script>
</body>
</html>
