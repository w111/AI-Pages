<!DOCTYPE html>
<!--
====================================================================================
                        TECHNICAL SPECIFICATION (TS)
                        Hand Gesture Theremin
====================================================================================

PROJECT OVERVIEW:
–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Ä–º–µ–Ω–≤–æ–∫—Å, —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π –∂–µ—Å—Ç–∞–º–∏ —Ä—É–∫ —á–µ—Ä–µ–∑ –≤–µ–±-–∫–∞–º–µ—Ä—É.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç MediaPipe Hands –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è 21 —Ç–æ—á–∫–∏ –∫–∞–∂–¥–æ–π —Ä—É–∫–∏.

CORE FEATURES:
1. –ó–∞—Ö–≤–∞—Ç –∫–∞–º–µ—Ä—ã —á–µ—Ä–µ–∑ getUserMedia API
2. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ä—É–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ MediaPipe Hands
3. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ 21 —Ç–æ—á–∫–∏ —Ä—É–∫–∏ –∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–∞ canvas
4. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∂–µ—Å—Ç–æ–≤ (‚úåÔ∏è üëç üëé üñêÔ∏è) –ø–æ —É–≥–ª–∞–º –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–≤—É–∫–∞ –∫–∞–∫ —Ç–µ—Ä–º–µ–Ω–≤–æ–∫—Å:
   - –ü—Ä–∞–≤–∞—è —Ä—É–∫–∞: X-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç —á–∞—Å—Ç–æ—Ç–æ–π (220-880 –ì—Ü)
   - –õ–µ–≤–∞—è —Ä—É–∫–∞: Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç –≥—Ä–æ–º–∫–æ—Å—Ç—å—é (0-1)
6. Web Audio API –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ –∑–≤—É–∫–∞ —Å –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–æ–º

TECHNICAL REQUIREMENTS:
- MediaPipe Hands —á–µ—Ä–µ–∑ CDN
- Web Audio API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–≤—É–∫–∞
- Canvas API –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
- getUserMedia –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ

AUTHOR: AI Assistant
VERSION: 1.0
LAST UPDATED: 2025
====================================================================================
-->
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hand Gesture Theremin - AI Pages</title>
  <style>
    :root {
      --primary: #8b5cf6;
      --secondary: #6366f1;
      --bg-dark: #0f0f1a;
      --bg-card: #1a1a2e;
      --text: #e2e8f0;
      --accent: #22d3ee;
      --success: #10b981;
      --warning: #f59e0b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }

    header {
      text-align: center;
      padding: 1.5rem 0;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 0 0 1rem 1rem;
      margin-bottom: 1.5rem;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .subtitle {
      opacity: 0.9;
      font-size: 1rem;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 1.5rem;
    }

    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .video-section {
      position: relative;
      background: var(--bg-card);
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .video-container {
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 3;
      background: #000;
    }

    #videoElement {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }

    #canvasElement {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transform: scaleX(-1);
    }

    .gesture-display {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: rgba(0, 0, 0, 0.7);
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      font-size: 2rem;
      display: flex;
      gap: 1rem;
    }

    .gesture-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.75rem;
    }

    .gesture-emoji {
      font-size: 2rem;
      line-height: 1;
    }

    .controls-panel {
      padding: 1rem;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--secondary);
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: black;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .panel {
      background: var(--bg-card);
      border-radius: 1rem;
      padding: 1.25rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .panel h3 {
      font-size: 1rem;
      margin-bottom: 1rem;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .sound-params {
      display: grid;
      gap: 1rem;
    }

    .param-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .param-label {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .param-value {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 1.1rem;
      color: var(--accent);
      min-width: 80px;
      text-align: right;
    }

    .frequency-bar, .volume-bar {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      margin-top: 0.5rem;
      overflow: hidden;
    }

    .frequency-bar-fill, .volume-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.1s ease;
    }

    .frequency-bar-fill {
      background: linear-gradient(90deg, var(--primary), var(--accent));
    }

    .volume-bar-fill {
      background: linear-gradient(90deg, var(--success), var(--warning));
    }

    .waveform-select {
      width: 100%;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.3);
      color: var(--text);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    .instructions {
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .instructions ul {
      list-style: none;
      padding: 0;
    }

    .instructions li {
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .instructions li:last-child {
      border-bottom: none;
    }

    .hand-icon {
      font-size: 1.5rem;
    }

    .gestures-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    .gesture-card {
      background: rgba(0, 0, 0, 0.3);
      padding: 0.75rem;
      border-radius: 0.5rem;
      text-align: center;
    }

    .gesture-card .emoji {
      font-size: 1.75rem;
      display: block;
      margin-bottom: 0.25rem;
    }

    .gesture-card .name {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ef4444;
    }

    .status-dot.active {
      background: var(--success);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      z-index: 10;
    }

    .loading-overlay.hidden {
      display: none;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(239, 68, 68, 0.9);
      padding: 1.5rem;
      border-radius: 0.5rem;
      text-align: center;
      max-width: 80%;
      z-index: 20;
    }

    .error-message.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <h1>Hand Gesture Theremin</h1>
    <p class="subtitle">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∑–≤—É–∫–æ–º –¥–≤–∏–∂–µ–Ω–∏—è–º–∏ —Ä—É–∫ –∫–∞–∫ –Ω–∞ —Ç–µ—Ä–º–µ–Ω–≤–æ–∫—Å–µ</p>
  </header>

  <div class="container">
    <div class="main-content">
      <div class="video-section">
        <div class="video-container">
          <video id="videoElement" playsinline autoplay muted></video>
          <canvas id="canvasElement"></canvas>

          <div class="gesture-display">
            <div class="gesture-item">
              <span class="gesture-emoji" id="leftGesture">-</span>
              <span>–õ–µ–≤–∞—è</span>
            </div>
            <div class="gesture-item">
              <span class="gesture-emoji" id="rightGesture">-</span>
              <span>–ü—Ä–∞–≤–∞—è</span>
            </div>
          </div>

          <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ MediaPipe...</p>
          </div>

          <div class="error-message hidden" id="errorMessage">
            <p>–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ</p>
          </div>
        </div>

        <div class="controls-panel">
          <button class="btn btn-primary" id="startBtn">
            <span>‚ñ∂</span> –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É
          </button>
          <button class="btn btn-success" id="soundBtn" disabled>
            <span>üîä</span> –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫
          </button>
        </div>
      </div>

      <div class="sidebar">
        <div class="panel">
          <h3>üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–≤—É–∫–∞</h3>

          <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
          </div>

          <div class="sound-params">
            <div>
              <div class="param-row">
                <span class="param-label">–ß–∞—Å—Ç–æ—Ç–∞ (Hz)</span>
                <span class="param-value" id="freqValue">0</span>
              </div>
              <div class="frequency-bar">
                <div class="frequency-bar-fill" id="freqBar" style="width: 0%"></div>
              </div>
            </div>

            <div>
              <div class="param-row">
                <span class="param-label">–ì—Ä–æ–º–∫–æ—Å—Ç—å</span>
                <span class="param-value" id="volValue">0%</span>
              </div>
              <div class="volume-bar">
                <div class="volume-bar-fill" id="volBar" style="width: 0%"></div>
              </div>
            </div>

            <div class="param-row">
              <span class="param-label">–¢–∏–ø –≤–æ–ª–Ω—ã</span>
            </div>
            <select class="waveform-select" id="waveformSelect">
              <option value="sine">–°–∏–Ω—É—Å–æ–∏–¥–∞ (–º—è–≥–∫–∏–π)</option>
              <option value="triangle">–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ (—Ç–µ–ø–ª—ã–π)</option>
              <option value="sawtooth">–ü–∏–ª–∞ (—Ä–µ–∑–∫–∏–π)</option>
              <option value="square">–ö–≤–∞–¥—Ä–∞—Ç (8-bit)</option>
            </select>
          </div>
        </div>

        <div class="panel">
          <h3>üëã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
          <div class="instructions">
            <ul>
              <li>
                <span class="hand-icon">üëâ</span>
                <span><strong>–ü—Ä–∞–≤–∞—è —Ä—É–∫–∞:</strong> –¥–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ –º–µ–Ω—è–µ—Ç —á–∞—Å—Ç–æ—Ç—É</span>
              </li>
              <li>
                <span class="hand-icon">üëà</span>
                <span><strong>–õ–µ–≤–∞—è —Ä—É–∫–∞:</strong> –¥–≤–∏–∂–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö-–≤–Ω–∏–∑ –º–µ–Ω—è–µ—Ç –≥—Ä–æ–º–∫–æ—Å—Ç—å</span>
              </li>
              <li>
                <span class="hand-icon">‚úä</span>
                <span><strong>–ö—É–ª–∞–∫:</strong> –æ—Ç–∫–ª—é—á–∞–µ—Ç –∑–≤—É–∫</span>
              </li>
            </ul>
          </div>
        </div>

        <div class="panel">
          <h3>‚úã –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–µ–º—ã–µ –∂–µ—Å—Ç—ã</h3>
          <div class="gestures-grid">
            <div class="gesture-card">
              <span class="emoji">üñêÔ∏è</span>
              <span class="name">–û—Ç–∫—Ä—ã—Ç–∞—è –ª–∞–¥–æ–Ω—å</span>
            </div>
            <div class="gesture-card">
              <span class="emoji">‚úåÔ∏è</span>
              <span class="name">–í–∏–∫—Ç–æ—Ä–∏—è</span>
            </div>
            <div class="gesture-card">
              <span class="emoji">üëç</span>
              <span class="name">–ü–∞–ª–µ—Ü –≤–≤–µ—Ä—Ö</span>
            </div>
            <div class="gesture-card">
              <span class="emoji">üëé</span>
              <span class="name">–ü–∞–ª–µ—Ü –≤–Ω–∏–∑</span>
            </div>
            <div class="gesture-card">
              <span class="emoji">‚òùÔ∏è</span>
              <span class="name">–£–∫–∞–∑–∞—Ç–µ–ª—å</span>
            </div>
            <div class="gesture-card">
              <span class="emoji">‚úä</span>
              <span class="name">–ö—É–ª–∞–∫</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

  <script>
    /**
     * Hand Gesture Theremin
     * –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤—É–∫–æ–º —á–µ—Ä–µ–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ä—É–∫ —Å MediaPipe
     */

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const videoElement = document.getElementById("videoElement");
    const canvasElement = document.getElementById("canvasElement");
    const canvasCtx = canvasElement.getContext("2d");
    const startBtn = document.getElementById("startBtn");
    const soundBtn = document.getElementById("soundBtn");
    const loadingOverlay = document.getElementById("loadingOverlay");
    const errorMessage = document.getElementById("errorMessage");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const freqValue = document.getElementById("freqValue");
    const volValue = document.getElementById("volValue");
    const freqBar = document.getElementById("freqBar");
    const volBar = document.getElementById("volBar");
    const waveformSelect = document.getElementById("waveformSelect");
    const leftGestureEl = document.getElementById("leftGesture");
    const rightGestureEl = document.getElementById("rightGesture");

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let camera = null;
    let hands = null;
    let audioContext = null;
    let oscillator = null;
    let gainNode = null;
    let isSoundEnabled = false;
    let isRunning = false;

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–≤—É–∫–∞
    const MIN_FREQ = 130.81; // C3
    const MAX_FREQ = 1046.50; // C6
    const SMOOTHING = 0.15;
    let currentFreq = MIN_FREQ;
    let currentVol = 0;
    let targetFreq = MIN_FREQ;
    let targetVol = 0;

    // –ò–Ω–¥–µ–∫—Å—ã —Ç–æ—á–µ–∫ —Ä—É–∫–∏ MediaPipe
    const LANDMARKS = {
      WRIST: 0,
      THUMB_CMC: 1, THUMB_MCP: 2, THUMB_IP: 3, THUMB_TIP: 4,
      INDEX_MCP: 5, INDEX_PIP: 6, INDEX_DIP: 7, INDEX_TIP: 8,
      MIDDLE_MCP: 9, MIDDLE_PIP: 10, MIDDLE_DIP: 11, MIDDLE_TIP: 12,
      RING_MCP: 13, RING_PIP: 14, RING_DIP: 15, RING_TIP: 16,
      PINKY_MCP: 17, PINKY_PIP: 18, PINKY_DIP: 19, PINKY_TIP: 20
    };

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Web Audio API
     */
    function initAudio() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();

      oscillator = audioContext.createOscillator();
      gainNode = audioContext.createGain();

      oscillator.type = waveformSelect.value;
      oscillator.frequency.setValueAtTime(MIN_FREQ, audioContext.currentTime);
      gainNode.gain.setValueAtTime(0, audioContext.currentTime);

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.start();
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–≤—É–∫–∞
     */
    function updateSound() {
      if (!audioContext || !isSoundEnabled) return;

      // –ü–ª–∞–≤–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
      currentFreq += (targetFreq - currentFreq) * SMOOTHING;
      currentVol += (targetVol - currentVol) * SMOOTHING;

      oscillator.frequency.setValueAtTime(currentFreq, audioContext.currentTime);
      gainNode.gain.setValueAtTime(currentVol * 0.3, audioContext.currentTime);

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
      const freqPercent = ((currentFreq - MIN_FREQ) / (MAX_FREQ - MIN_FREQ)) * 100;
      freqValue.textContent = Math.round(currentFreq);
      freqBar.style.width = freqPercent + "%";

      volValue.textContent = Math.round(currentVol * 100) + "%";
      volBar.style.width = (currentVol * 100) + "%";

      requestAnimationFrame(updateSound);
    }

    /**
     * –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —É–≥–ª–∞ –º–µ–∂–¥—É —Ç—Ä–µ–º—è —Ç–æ—á–∫–∞–º–∏
     */
    function getAngle(p1, p2, p3) {
      const rad = Math.atan2(p3.y - p2.y, p3.x - p2.x) -
                  Math.atan2(p1.y - p2.y, p1.x - p2.x);
      let deg = Math.abs(rad * 180 / Math.PI);
      if (deg > 180) deg = 360 - deg;
      return deg;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–æ–≥–Ω—É—Ç –ª–∏ –ø–∞–ª–µ—Ü
     */
    function isFingerCurled(landmarks, fingerTip, fingerPip, fingerMcp) {
      const tip = landmarks[fingerTip];
      const pip = landmarks[fingerPip];
      const mcp = landmarks[fingerMcp];
      const wrist = landmarks[LANDMARKS.WRIST];

      // –ü–∞–ª–µ—Ü —Å–æ–≥–Ω—É—Ç –µ—Å–ª–∏ –∫–æ–Ω—á–∏–∫ –±–ª–∏–∂–µ –∫ –∑–∞–ø—è—Å—Ç—å—é —á–µ–º —Å—Ä–µ–¥–Ω–∏–π —Å—É—Å—Ç–∞–≤
      const tipDist = Math.hypot(tip.x - wrist.x, tip.y - wrist.y);
      const pipDist = Math.hypot(pip.x - wrist.x, pip.y - wrist.y);

      return tipDist < pipDist * 1.1;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞, –≤—ã–ø—Ä—è–º–ª–µ–Ω –ª–∏ –ø–∞–ª–µ—Ü
     */
    function isFingerExtended(landmarks, fingerTip, fingerPip, fingerMcp) {
      return !isFingerCurled(landmarks, fingerTip, fingerPip, fingerMcp);
    }

    /**
     * –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∂–µ—Å—Ç–∞ —Ä—É–∫–∏
     */
    function recognizeGesture(landmarks) {
      const thumbExtended = isFingerExtended(
        landmarks, LANDMARKS.THUMB_TIP, LANDMARKS.THUMB_IP, LANDMARKS.THUMB_MCP
      );
      const indexExtended = isFingerExtended(
        landmarks, LANDMARKS.INDEX_TIP, LANDMARKS.INDEX_PIP, LANDMARKS.INDEX_MCP
      );
      const middleExtended = isFingerExtended(
        landmarks, LANDMARKS.MIDDLE_TIP, LANDMARKS.MIDDLE_PIP, LANDMARKS.MIDDLE_MCP
      );
      const ringExtended = isFingerExtended(
        landmarks, LANDMARKS.RING_TIP, LANDMARKS.RING_PIP, LANDMARKS.RING_MCP
      );
      const pinkyExtended = isFingerExtended(
        landmarks, LANDMARKS.PINKY_TIP, LANDMARKS.PINKY_PIP, LANDMARKS.PINKY_MCP
      );

      // –û—Ç–∫—Ä—ã—Ç–∞—è –ª–∞–¥–æ–Ω—å - –≤—Å–µ –ø–∞–ª—å—Ü—ã –≤—ã–ø—Ä—è–º–ª–µ–Ω—ã
      if (thumbExtended && indexExtended && middleExtended &&
          ringExtended && pinkyExtended) {
        return { name: "open", emoji: "üñêÔ∏è" };
      }

      // –í–∏–∫—Ç–æ—Ä–∏—è - —É–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π –∏ —Å—Ä–µ–¥–Ω–∏–π –≤—ã–ø—Ä—è–º–ª–µ–Ω—ã
      if (indexExtended && middleExtended &&
          !ringExtended && !pinkyExtended) {
        return { name: "victory", emoji: "‚úåÔ∏è" };
      }

      // –£–∫–∞–∑–∞—Ç–µ–ª—å - —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π –≤—ã–ø—Ä—è–º–ª–µ–Ω
      if (indexExtended && !middleExtended &&
          !ringExtended && !pinkyExtended) {
        return { name: "point", emoji: "‚òùÔ∏è" };
      }

      // –ü–∞–ª–µ—Ü –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑
      if (thumbExtended && !indexExtended && !middleExtended &&
          !ringExtended && !pinkyExtended) {
        const thumbTip = landmarks[LANDMARKS.THUMB_TIP];
        const wrist = landmarks[LANDMARKS.WRIST];
        if (thumbTip.y < wrist.y) {
          return { name: "thumbs_up", emoji: "üëç" };
        } else {
          return { name: "thumbs_down", emoji: "üëé" };
        }
      }

      // –ö—É–ª–∞–∫ - –≤—Å–µ –ø–∞–ª—å—Ü—ã —Å–æ–≥–Ω—É—Ç—ã
      if (!thumbExtended && !indexExtended && !middleExtended &&
          !ringExtended && !pinkyExtended) {
        return { name: "fist", emoji: "‚úä" };
      }

      return { name: "unknown", emoji: "‚ùì" };
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ MediaPipe
     */
    function onResults(results) {
      canvasElement.width = videoElement.videoWidth;
      canvasElement.height = videoElement.videoHeight;

      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

      let leftHand = null;
      let rightHand = null;

      if (results.multiHandLandmarks && results.multiHandedness) {
        for (let i = 0; i < results.multiHandLandmarks.length; i++) {
          const landmarks = results.multiHandLandmarks[i];
          const handedness = results.multiHandedness[i];

          // MediaPipe –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "Left"/"Right" –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∑–µ—Ä–∫–∞–ª—å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          const isRightHand = handedness.label === "Left"; // –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏–∑-–∑–∞ –∑–µ—Ä–∫–∞–ª–∞

          if (isRightHand) {
            rightHand = landmarks;
          } else {
            leftHand = landmarks;
          }

          // –†–∏—Å—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
          drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
            color: isRightHand ? "#8b5cf6" : "#22d3ee",
            lineWidth: 3
          });

          // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏
          drawLandmarks(canvasCtx, landmarks, {
            color: isRightHand ? "#c4b5fd" : "#67e8f9",
            lineWidth: 1,
            radius: 4
          });

          // –†–∞—Å–ø–æ–∑–Ω–∞–µ–º –∂–µ—Å—Ç
          const gesture = recognizeGesture(landmarks);
          if (isRightHand) {
            rightGestureEl.textContent = gesture.emoji;
          } else {
            leftGestureEl.textContent = gesture.emoji;
          }
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–≤—É–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–∏ —Ä—É–∫
      if (rightHand) {
        // X-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –ø—Ä–∞–≤–æ–π —Ä—É–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç —á–∞—Å—Ç–æ—Ç–æ–π
        const palmX = rightHand[LANDMARKS.WRIST].x;
        targetFreq = MIN_FREQ + (1 - palmX) * (MAX_FREQ - MIN_FREQ);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∂–µ—Å—Ç - –∫—É–ª–∞–∫ –æ—Ç–∫–ª—é—á–∞–µ—Ç –∑–≤—É–∫
        const rightGesture = recognizeGesture(rightHand);
        if (rightGesture.name === "fist") {
          targetVol = 0;
        }
      }

      if (leftHand) {
        // Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –ª–µ–≤–æ–π —Ä—É–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –≥—Ä–æ–º–∫–æ—Å—Ç—å—é
        const palmY = leftHand[LANDMARKS.WRIST].y;
        targetVol = Math.max(0, Math.min(1, 1 - palmY));

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∂–µ—Å—Ç - –∫—É–ª–∞–∫ –æ—Ç–∫–ª—é—á–∞–µ—Ç –∑–≤—É–∫
        const leftGesture = recognizeGesture(leftHand);
        if (leftGesture.name === "fist") {
          targetVol = 0;
        }
      }

      // –ï—Å–ª–∏ –Ω–µ—Ç —Ä—É–∫ –≤ –∫–∞–¥—Ä–µ
      if (!leftHand && !rightHand) {
        leftGestureEl.textContent = "-";
        rightGestureEl.textContent = "-";
        targetVol = 0;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        statusDot.classList.add("active");
        const handCount = results.multiHandLandmarks.length;
        statusText.textContent = `–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ä—É–∫: ${handCount}`;
      } else {
        statusDot.classList.remove("active");
        statusText.textContent = "–ü–æ–∫–∞–∂–∏—Ç–µ —Ä—É–∫–∏ –∫–∞–º–µ—Ä–µ";
      }

      canvasCtx.restore();
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MediaPipe Hands
     */
    async function initMediaPipe() {
      hands = new Hands({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }
      });

      hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.5
      });

      hands.onResults(onResults);
    }

    /**
     * –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
     */
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: "user"
          }
        });

        videoElement.srcObject = stream;
        await videoElement.play();

        camera = new Camera(videoElement, {
          onFrame: async () => {
            await hands.send({ image: videoElement });
          },
          width: 1280,
          height: 720
        });

        await camera.start();

        loadingOverlay.classList.add("hidden");
        startBtn.innerHTML = "<span>‚èπ</span> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å";
        soundBtn.disabled = false;
        isRunning = true;

      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", error);
        loadingOverlay.classList.add("hidden");
        errorMessage.classList.remove("hidden");
        errorMessage.querySelector("p").textContent =
          "–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.";
      }
    }

    /**
     * –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
     */
    function stopCamera() {
      if (camera) {
        camera.stop();
        camera = null;
      }

      const stream = videoElement.srcObject;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        videoElement.srcObject = null;
      }

      startBtn.innerHTML = "<span>‚ñ∂</span> –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É";
      soundBtn.disabled = true;
      isRunning = false;

      // –û—Ç–∫–ª—é—á–∞–µ–º –∑–≤—É–∫
      if (isSoundEnabled) {
        toggleSound();
      }
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–≤—É–∫–∞
     */
    function toggleSound() {
      if (!audioContext) {
        initAudio();
      }

      if (audioContext.state === "suspended") {
        audioContext.resume();
      }

      isSoundEnabled = !isSoundEnabled;

      if (isSoundEnabled) {
        soundBtn.innerHTML = "<span>üîá</span> –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫";
        soundBtn.classList.remove("btn-success");
        soundBtn.classList.add("btn-warning");
        updateSound();
      } else {
        soundBtn.innerHTML = "<span>üîä</span> –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫";
        soundBtn.classList.remove("btn-warning");
        soundBtn.classList.add("btn-success");
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    startBtn.addEventListener("click", async () => {
      if (isRunning) {
        stopCamera();
      } else {
        loadingOverlay.classList.remove("hidden");
        await initMediaPipe();
        await startCamera();
      }
    });

    soundBtn.addEventListener("click", toggleSound);

    waveformSelect.addEventListener("change", () => {
      if (oscillator) {
        oscillator.type = waveformSelect.value;
      }
    });

    // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadingOverlay.classList.add("hidden");
  </script>
</body>
</html>
