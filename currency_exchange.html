<!DOCTYPE html>
<!--
ТЕХНИЧЕСКОЕ ЗАДАНИЕ

Цель: Создать интерактивную страницу с курсами валют и конвертером.

Функциональные требования:
1. Отображение курсов валют:
   - Получение данных через ExchangeRate API
   - Выбор базовой валюты
   - Таблица с курсами всех доступных валют
   - Поиск по валютам
   - Сортировка по имени и курсу

2. Конвертер валют:
   - Выбор исходной и целевой валюты
   - Ввод суммы для конвертации
   - Мгновенный расчет результата
   - Кнопка смены направления конвертации

3. Пользовательский интерфейс:
   - Темная и светлая тема
   - Многоязычность (русский/английский)
   - Адаптивный дизайн для мобильных устройств
   - Сохранение настроек в localStorage

Технические требования:
1. Использование ExchangeRate API (api.exchangerate-api.com)
2. Vanilla JavaScript без фреймворков
3. Кэширование данных в localStorage
4. Адаптивный CSS с использованием Flexbox и Grid
5. Семантическая HTML-структура
-->
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Курсы валют | Currency Exchange</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-color: #f0f4f8;
      --text-color: #1a202c;
      --card-bg: #ffffff;
      --border-color: #e2e8f0;
      --primary-color: #3182ce;
      --primary-hover: #2c5282;
      --secondary-color: #718096;
      --input-bg: #ffffff;
      --input-border: #cbd5e0;
      --success-color: #38a169;
      --warning-color: #d69e2e;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] {
      --bg-color: #1a202c;
      --text-color: #e2e8f0;
      --card-bg: #2d3748;
      --border-color: #4a5568;
      --primary-color: #63b3ed;
      --primary-hover: #4299e1;
      --secondary-color: #a0aec0;
      --input-bg: #2d3748;
      --input-border: #4a5568;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      transition: background-color 0.3s ease, color 0.3s ease;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: var(--primary-color);
    }

    h1 i {
      margin-right: 10px;
    }

    .subtitle {
      color: var(--secondary-color);
      font-size: 1.1rem;
    }

    .last-update {
      margin-top: 10px;
      font-size: 0.9rem;
      color: var(--secondary-color);
    }

    /* Settings button */
    .settings-button {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--primary-color);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      transition: transform 0.3s ease, background-color 0.3s ease;
      z-index: 1000;
    }

    .settings-button:hover {
      transform: rotate(45deg);
    }

    /* Settings modal */
    .settings-modal {
      display: none;
      position: fixed;
      top: 75px;
      right: 20px;
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow-lg);
      z-index: 999;
      min-width: 250px;
      border: 1px solid var(--border-color);
    }

    .settings-modal.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .settings-title {
      font-size: 1.2rem;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .settings-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .settings-option label {
      font-size: 0.95rem;
      cursor: pointer;
    }

    /* Toggle switch */
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 26px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary-color);
    }

    input:checked + .slider:before {
      transform: translateX(24px);
    }

    /* Main grid */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Cards */
    .card {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }

    .card-title {
      font-size: 1.3rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary-color);
    }

    /* Converter */
    .converter-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      align-items: flex-end;
    }

    .converter-field {
      flex: 1;
    }

    .converter-field label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.9rem;
      color: var(--secondary-color);
    }

    .converter-field input,
    .converter-field select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--input-border);
      border-radius: 8px;
      font-size: 1rem;
      background-color: var(--input-bg);
      color: var(--text-color);
      transition: border-color 0.3s ease;
    }

    .converter-field input:focus,
    .converter-field select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .swap-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background-color 0.3s ease, transform 0.3s ease;
      flex-shrink: 0;
    }

    .swap-button:hover {
      background-color: var(--primary-hover);
      transform: rotate(180deg);
    }

    .result-box {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-top: 20px;
    }

    .result-value {
      font-size: 2rem;
      font-weight: bold;
    }

    .result-info {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-top: 5px;
    }

    /* Rates table */
    .rates-card {
      grid-column: span 2;
    }

    @media (max-width: 900px) {
      .rates-card {
        grid-column: span 1;
      }
    }

    .rates-header {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 12px 15px;
      border: 2px solid var(--input-border);
      border-radius: 8px;
      font-size: 1rem;
      background-color: var(--input-bg);
      color: var(--text-color);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .base-select {
      padding: 12px 15px;
      border: 2px solid var(--input-border);
      border-radius: 8px;
      font-size: 1rem;
      background-color: var(--input-bg);
      color: var(--text-color);
      min-width: 150px;
    }

    .rates-table-container {
      max-height: 500px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .rates-table {
      width: 100%;
      border-collapse: collapse;
    }

    .rates-table th,
    .rates-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .rates-table th {
      background-color: var(--primary-color);
      color: white;
      position: sticky;
      top: 0;
      cursor: pointer;
      user-select: none;
    }

    .rates-table th:hover {
      background-color: var(--primary-hover);
    }

    .rates-table th i {
      margin-left: 5px;
      font-size: 0.8rem;
    }

    .rates-table tr:hover {
      background-color: var(--bg-color);
    }

    .currency-code {
      font-weight: bold;
      color: var(--primary-color);
    }

    .currency-name {
      color: var(--secondary-color);
      font-size: 0.9rem;
    }

    .rate-value {
      font-family: 'Courier New', monospace;
      font-weight: bold;
    }

    /* Popular currencies */
    .popular-currencies {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px;
    }

    .popular-item {
      background-color: var(--bg-color);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 2px solid transparent;
    }

    .popular-item:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow);
      border-color: var(--primary-color);
    }

    .popular-code {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary-color);
    }

    .popular-rate {
      font-size: 1.1rem;
      margin-top: 5px;
    }

    .popular-name {
      font-size: 0.8rem;
      color: var(--secondary-color);
      margin-top: 3px;
    }

    /* Loading & Error states */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--secondary-color);
    }

    .loading i {
      font-size: 3rem;
      animation: spin 1s linear infinite;
      color: var(--primary-color);
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .error {
      text-align: center;
      padding: 40px;
      color: #e53e3e;
    }

    .error i {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    .retry-button {
      margin-top: 15px;
      padding: 10px 25px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
    }

    .retry-button:hover {
      background-color: var(--primary-hover);
    }

    /* Footer */
    footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      color: var(--secondary-color);
      font-size: 0.9rem;
    }

    footer a {
      color: var(--primary-color);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 600px) {
      h1 {
        font-size: 1.8rem;
      }

      .converter-row {
        flex-direction: column;
        align-items: stretch;
      }

      .swap-button {
        align-self: center;
      }

      .rates-header {
        flex-direction: column;
      }

      .search-input,
      .base-select {
        width: 100%;
      }

      .popular-currencies {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Settings button -->
  <button class="settings-button" id="settingsButton" aria-label="Settings">
    <i class="fas fa-cog"></i>
  </button>

  <!-- Settings modal -->
  <div class="settings-modal" id="settingsModal">
    <h3 class="settings-title" data-i18n="settings">Настройки</h3>
    <div class="settings-option">
      <label for="themeSwitch" data-i18n="darkTheme">Темная тема</label>
      <label class="toggle-switch">
        <input type="checkbox" id="themeSwitch">
        <span class="slider"></span>
      </label>
    </div>
    <div class="settings-option">
      <label for="langSwitch" data-i18n="english">English</label>
      <label class="toggle-switch">
        <input type="checkbox" id="langSwitch">
        <span class="slider"></span>
      </label>
    </div>
  </div>

  <div class="container">
    <header>
      <h1><i class="fas fa-coins"></i><span data-i18n="title">Курсы валют</span></h1>
      <p class="subtitle" data-i18n="subtitle">Актуальные курсы обмена валют в реальном времени</p>
      <p class="last-update" id="lastUpdate"></p>
    </header>

    <div class="main-grid">
      <!-- Converter -->
      <div class="card">
        <h2 class="card-title">
          <i class="fas fa-exchange-alt"></i>
          <span data-i18n="converter">Конвертер валют</span>
        </h2>
        <div class="converter-row">
          <div class="converter-field">
            <label data-i18n="amount">Сумма</label>
            <input type="number" id="amount" value="1" min="0" step="any">
          </div>
          <div class="converter-field">
            <label data-i18n="from">Из</label>
            <select id="fromCurrency"></select>
          </div>
        </div>
        <div class="converter-row">
          <div class="converter-field">
            <label data-i18n="to">В</label>
            <select id="toCurrency"></select>
          </div>
          <button class="swap-button" id="swapButton" aria-label="Swap currencies">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
        <div class="result-box">
          <div class="result-value" id="resultValue">0.00</div>
          <div class="result-info" id="resultInfo"></div>
        </div>
      </div>

      <!-- Popular currencies -->
      <div class="card">
        <h2 class="card-title">
          <i class="fas fa-star"></i>
          <span data-i18n="popular">Популярные валюты</span>
        </h2>
        <div class="popular-currencies" id="popularCurrencies">
          <div class="loading">
            <i class="fas fa-spinner"></i>
          </div>
        </div>
      </div>

      <!-- Rates table -->
      <div class="card rates-card">
        <h2 class="card-title">
          <i class="fas fa-list"></i>
          <span data-i18n="allRates">Все курсы</span>
        </h2>
        <div class="rates-header">
          <input type="text" class="search-input" id="searchInput" data-i18n-placeholder="searchPlaceholder" placeholder="Поиск валюты...">
          <select class="base-select" id="baseCurrency"></select>
        </div>
        <div class="rates-table-container" id="ratesContainer">
          <div class="loading">
            <i class="fas fa-spinner"></i>
            <p data-i18n="loading">Загрузка...</p>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p data-i18n="dataSource">Данные предоставлены</p>
      <a href="https://www.exchangerate-api.com" target="_blank" rel="noopener">ExchangeRate-API</a>
    </footer>
  </div>

  <script>
    /**
     * Словарь переводов для интернационализации
     */
    const translations = {
      ru: {
        title: "Курсы валют",
        subtitle: "Актуальные курсы обмена валют в реальном времени",
        settings: "Настройки",
        darkTheme: "Темная тема",
        english: "English",
        converter: "Конвертер валют",
        amount: "Сумма",
        from: "Из",
        to: "В",
        popular: "Популярные валюты",
        allRates: "Все курсы",
        searchPlaceholder: "Поиск валюты...",
        loading: "Загрузка...",
        error: "Ошибка загрузки данных",
        retry: "Повторить",
        lastUpdate: "Последнее обновление:",
        dataSource: "Данные предоставлены",
        currency: "Валюта",
        rate: "Курс"
      },
      en: {
        title: "Exchange Rates",
        subtitle: "Real-time currency exchange rates",
        settings: "Settings",
        darkTheme: "Dark theme",
        english: "English",
        converter: "Currency Converter",
        amount: "Amount",
        from: "From",
        to: "To",
        popular: "Popular Currencies",
        allRates: "All Rates",
        searchPlaceholder: "Search currency...",
        loading: "Loading...",
        error: "Error loading data",
        retry: "Retry",
        lastUpdate: "Last update:",
        dataSource: "Data provided by",
        currency: "Currency",
        rate: "Rate"
      }
    };

    /**
     * Названия валют для отображения
     */
    const currencyNames = {
      USD: { ru: "Доллар США", en: "US Dollar" },
      EUR: { ru: "Евро", en: "Euro" },
      GBP: { ru: "Фунт стерлингов", en: "British Pound" },
      JPY: { ru: "Японская иена", en: "Japanese Yen" },
      CNY: { ru: "Китайский юань", en: "Chinese Yuan" },
      RUB: { ru: "Российский рубль", en: "Russian Ruble" },
      CHF: { ru: "Швейцарский франк", en: "Swiss Franc" },
      AUD: { ru: "Австралийский доллар", en: "Australian Dollar" },
      CAD: { ru: "Канадский доллар", en: "Canadian Dollar" },
      INR: { ru: "Индийская рупия", en: "Indian Rupee" },
      KRW: { ru: "Южнокорейская вона", en: "South Korean Won" },
      BRL: { ru: "Бразильский реал", en: "Brazilian Real" },
      MXN: { ru: "Мексиканское песо", en: "Mexican Peso" },
      TRY: { ru: "Турецкая лира", en: "Turkish Lira" },
      PLN: { ru: "Польский злотый", en: "Polish Zloty" },
      SEK: { ru: "Шведская крона", en: "Swedish Krona" },
      NOK: { ru: "Норвежская крона", en: "Norwegian Krone" },
      DKK: { ru: "Датская крона", en: "Danish Krone" },
      NZD: { ru: "Новозеландский доллар", en: "New Zealand Dollar" },
      SGD: { ru: "Сингапурский доллар", en: "Singapore Dollar" },
      HKD: { ru: "Гонконгский доллар", en: "Hong Kong Dollar" },
      ZAR: { ru: "Южноафриканский рэнд", en: "South African Rand" },
      THB: { ru: "Тайский бат", en: "Thai Baht" },
      AED: { ru: "Дирхам ОАЭ", en: "UAE Dirham" },
      SAR: { ru: "Саудовский риял", en: "Saudi Riyal" },
      ILS: { ru: "Израильский шекель", en: "Israeli Shekel" },
      CZK: { ru: "Чешская крона", en: "Czech Koruna" },
      HUF: { ru: "Венгерский форинт", en: "Hungarian Forint" },
      UAH: { ru: "Украинская гривна", en: "Ukrainian Hryvnia" },
      KZT: { ru: "Казахстанский тенге", en: "Kazakhstani Tenge" },
      BYN: { ru: "Белорусский рубль", en: "Belarusian Ruble" },
      GEL: { ru: "Грузинский лари", en: "Georgian Lari" },
      AMD: { ru: "Армянский драм", en: "Armenian Dram" },
      AZN: { ru: "Азербайджанский манат", en: "Azerbaijani Manat" }
    };

    /**
     * Популярные валюты для быстрого доступа
     */
    const popularCurrencies = ["USD", "EUR", "GBP", "JPY", "CNY", "RUB", "CHF", "AUD"];

    /**
     * Состояние приложения
     */
    let state = {
      rates: {},
      baseCurrency: "USD",
      fromCurrency: "USD",
      toCurrency: "EUR",
      amount: 1,
      lang: "ru",
      theme: "light",
      sortField: "code",
      sortAsc: true,
      lastUpdate: null
    };

    /**
     * Загрузка настроек из localStorage
     */
    function loadSettings() {
      const saved = localStorage.getItem("currencyExchangeSettings");
      if (saved) {
        const settings = JSON.parse(saved);
        state.baseCurrency = settings.baseCurrency || "USD";
        state.fromCurrency = settings.fromCurrency || "USD";
        state.toCurrency = settings.toCurrency || "EUR";
        state.lang = settings.lang || "ru";
        state.theme = settings.theme || "light";
      }
    }

    /**
     * Сохранение настроек в localStorage
     */
    function saveSettings() {
      localStorage.setItem("currencyExchangeSettings", JSON.stringify({
        baseCurrency: state.baseCurrency,
        fromCurrency: state.fromCurrency,
        toCurrency: state.toCurrency,
        lang: state.lang,
        theme: state.theme
      }));
    }

    /**
     * Применение темы
     */
    function applyTheme() {
      document.body.setAttribute("data-theme", state.theme);
      document.getElementById("themeSwitch").checked = state.theme === "dark";
    }

    /**
     * Применение языка
     */
    function applyLanguage() {
      const t = translations[state.lang];
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (t[key]) {
          el.textContent = t[key];
        }
      });
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        const key = el.getAttribute("data-i18n-placeholder");
        if (t[key]) {
          el.placeholder = t[key];
        }
      });
      document.getElementById("langSwitch").checked = state.lang === "en";
    }

    /**
     * Получение курсов валют с API
     * @param {string} base - Базовая валюта
     */
    async function fetchRates(base = "USD") {
      const cacheKey = `rates_${base}`;
      const cached = localStorage.getItem(cacheKey);

      // Проверяем кэш (10 минут)
      if (cached) {
        const { data, timestamp } = JSON.parse(cached);
        if (Date.now() - timestamp < 10 * 60 * 1000) {
          return data;
        }
      }

      const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${base}`);
      if (!response.ok) {
        throw new Error("Failed to fetch rates");
      }

      const data = await response.json();

      // Сохраняем в кэш
      localStorage.setItem(cacheKey, JSON.stringify({
        data,
        timestamp: Date.now()
      }));

      return data;
    }

    /**
     * Загрузка и отображение данных
     */
    async function loadData() {
      showLoading();

      try {
        const data = await fetchRates(state.baseCurrency);
        state.rates = data.rates;
        state.lastUpdate = new Date(data.time_last_updated * 1000);

        updateUI();
      } catch (error) {
        console.error("Error fetching rates:", error);
        showError();
      }
    }

    /**
     * Показ состояния загрузки
     */
    function showLoading() {
      const t = translations[state.lang];
      document.getElementById("ratesContainer").innerHTML = `
        <div class="loading">
          <i class="fas fa-spinner"></i>
          <p>${t.loading}</p>
        </div>
      `;
      document.getElementById("popularCurrencies").innerHTML = `
        <div class="loading">
          <i class="fas fa-spinner"></i>
        </div>
      `;
    }

    /**
     * Показ ошибки
     */
    function showError() {
      const t = translations[state.lang];
      document.getElementById("ratesContainer").innerHTML = `
        <div class="error">
          <i class="fas fa-exclamation-triangle"></i>
          <p>${t.error}</p>
          <button class="retry-button" onclick="loadData()">
            <i class="fas fa-redo"></i> ${t.retry}
          </button>
        </div>
      `;
    }

    /**
     * Обновление UI
     */
    function updateUI() {
      updateLastUpdate();
      updateSelects();
      updatePopularCurrencies();
      updateRatesTable();
      updateConverter();
    }

    /**
     * Обновление времени последнего обновления
     */
    function updateLastUpdate() {
      const t = translations[state.lang];
      const el = document.getElementById("lastUpdate");
      if (state.lastUpdate) {
        const options = {
          day: "numeric",
          month: "long",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit"
        };
        const formatted = state.lastUpdate.toLocaleDateString(
          state.lang === "ru" ? "ru-RU" : "en-US",
          options
        );
        el.textContent = `${t.lastUpdate} ${formatted}`;
      }
    }

    /**
     * Обновление выпадающих списков
     */
    function updateSelects() {
      const currencies = Object.keys(state.rates).sort();
      const options = currencies.map(code => {
        const name = currencyNames[code]?.[state.lang] || code;
        return `<option value="${code}">${code} - ${name}</option>`;
      }).join("");

      document.getElementById("fromCurrency").innerHTML = options;
      document.getElementById("toCurrency").innerHTML = options;
      document.getElementById("baseCurrency").innerHTML = options;

      document.getElementById("fromCurrency").value = state.fromCurrency;
      document.getElementById("toCurrency").value = state.toCurrency;
      document.getElementById("baseCurrency").value = state.baseCurrency;
    }

    /**
     * Обновление популярных валют
     */
    function updatePopularCurrencies() {
      const container = document.getElementById("popularCurrencies");
      const html = popularCurrencies
        .filter(code => state.rates[code])
        .map(code => {
          const rate = state.rates[code];
          const name = currencyNames[code]?.[state.lang] || code;
          return `
            <div class="popular-item" onclick="selectCurrency('${code}')">
              <div class="popular-code">${code}</div>
              <div class="popular-rate">${formatRate(rate)}</div>
              <div class="popular-name">${name}</div>
            </div>
          `;
        }).join("");

      container.innerHTML = html;
    }

    /**
     * Выбор валюты из популярных
     * @param {string} code - Код валюты
     */
    function selectCurrency(code) {
      state.toCurrency = code;
      document.getElementById("toCurrency").value = code;
      updateConverter();
      saveSettings();
    }

    /**
     * Обновление таблицы курсов
     */
    function updateRatesTable() {
      const t = translations[state.lang];
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();

      let entries = Object.entries(state.rates)
        .filter(([code]) => {
          const name = currencyNames[code]?.[state.lang] || "";
          return code.toLowerCase().includes(searchTerm) ||
                 name.toLowerCase().includes(searchTerm);
        });

      // Сортировка
      entries.sort((a, b) => {
        let valA, valB;
        if (state.sortField === "code") {
          valA = a[0];
          valB = b[0];
        } else {
          valA = a[1];
          valB = b[1];
        }

        if (valA < valB) return state.sortAsc ? -1 : 1;
        if (valA > valB) return state.sortAsc ? 1 : -1;
        return 0;
      });

      const sortIcon = state.sortAsc ? "fa-sort-up" : "fa-sort-down";

      const html = `
        <table class="rates-table">
          <thead>
            <tr>
              <th onclick="sortTable('code')">
                ${t.currency}
                ${state.sortField === "code" ? `<i class="fas ${sortIcon}"></i>` : ""}
              </th>
              <th onclick="sortTable('rate')">
                ${t.rate} (${state.baseCurrency})
                ${state.sortField === "rate" ? `<i class="fas ${sortIcon}"></i>` : ""}
              </th>
            </tr>
          </thead>
          <tbody>
            ${entries.map(([code, rate]) => {
              const name = currencyNames[code]?.[state.lang] || "";
              return `
                <tr>
                  <td>
                    <span class="currency-code">${code}</span>
                    ${name ? `<br><span class="currency-name">${name}</span>` : ""}
                  </td>
                  <td class="rate-value">${formatRate(rate)}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;

      document.getElementById("ratesContainer").innerHTML = html;
    }

    /**
     * Сортировка таблицы
     * @param {string} field - Поле для сортировки
     */
    function sortTable(field) {
      if (state.sortField === field) {
        state.sortAsc = !state.sortAsc;
      } else {
        state.sortField = field;
        state.sortAsc = true;
      }
      updateRatesTable();
    }

    /**
     * Обновление конвертера
     */
    function updateConverter() {
      const amount = parseFloat(document.getElementById("amount").value) || 0;
      const from = document.getElementById("fromCurrency").value;
      const to = document.getElementById("toCurrency").value;

      state.amount = amount;
      state.fromCurrency = from;
      state.toCurrency = to;

      // Конвертация через базовую валюту
      const fromRate = state.rates[from] || 1;
      const toRate = state.rates[to] || 1;
      const result = (amount / fromRate) * toRate;

      document.getElementById("resultValue").textContent = formatNumber(result);
      document.getElementById("resultInfo").textContent =
        `${formatNumber(amount)} ${from} = ${formatNumber(result)} ${to}`;

      saveSettings();
    }

    /**
     * Смена направления конвертации
     */
    function swapCurrencies() {
      const temp = state.fromCurrency;
      state.fromCurrency = state.toCurrency;
      state.toCurrency = temp;

      document.getElementById("fromCurrency").value = state.fromCurrency;
      document.getElementById("toCurrency").value = state.toCurrency;

      updateConverter();
    }

    /**
     * Форматирование курса
     * @param {number} rate - Курс
     * @returns {string} Отформатированный курс
     */
    function formatRate(rate) {
      if (rate >= 1000) {
        return rate.toLocaleString(state.lang === "ru" ? "ru-RU" : "en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      } else if (rate >= 1) {
        return rate.toLocaleString(state.lang === "ru" ? "ru-RU" : "en-US", {
          minimumFractionDigits: 4,
          maximumFractionDigits: 4
        });
      } else {
        return rate.toLocaleString(state.lang === "ru" ? "ru-RU" : "en-US", {
          minimumFractionDigits: 6,
          maximumFractionDigits: 6
        });
      }
    }

    /**
     * Форматирование числа
     * @param {number} num - Число
     * @returns {string} Отформатированное число
     */
    function formatNumber(num) {
      return num.toLocaleString(state.lang === "ru" ? "ru-RU" : "en-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    /**
     * Инициализация приложения
     */
    function init() {
      loadSettings();
      applyTheme();
      applyLanguage();

      // Обработчики событий
      document.getElementById("settingsButton").addEventListener("click", () => {
        document.getElementById("settingsModal").classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
        const modal = document.getElementById("settingsModal");
        const button = document.getElementById("settingsButton");
        if (!modal.contains(e.target) && !button.contains(e.target)) {
          modal.classList.remove("show");
        }
      });

      document.getElementById("themeSwitch").addEventListener("change", (e) => {
        state.theme = e.target.checked ? "dark" : "light";
        applyTheme();
        saveSettings();
      });

      document.getElementById("langSwitch").addEventListener("change", (e) => {
        state.lang = e.target.checked ? "en" : "ru";
        applyLanguage();
        updateUI();
        saveSettings();
      });

      document.getElementById("amount").addEventListener("input", updateConverter);
      document.getElementById("fromCurrency").addEventListener("change", updateConverter);
      document.getElementById("toCurrency").addEventListener("change", updateConverter);
      document.getElementById("swapButton").addEventListener("click", swapCurrencies);

      document.getElementById("baseCurrency").addEventListener("change", async (e) => {
        state.baseCurrency = e.target.value;
        saveSettings();
        await loadData();
      });

      document.getElementById("searchInput").addEventListener("input", updateRatesTable);

      // Загрузка данных
      loadData();
    }

    // Запуск приложения
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
